<!-- Barra de Herramientas con botón para volver -->
<p-toolbar styleClass="mb-3 max-w-[960px] mx-auto mt-4 rounded-md shadow-sm">
  <div class="p-toolbar-group-left">
    <button pButton icon="pi pi-arrow-left" label="Volver" (click)="goBack()"></button>
  </div>
</p-toolbar>
<!-- Indicador de Carga con Overlay -->
<div *ngIf="isLoading" class="loading-spinner-overlay">
  <div class="spinner"></div>
  <p>Realizando análisis con IA...</p>
</div>

<div class="container">
  <h1>Análisis de Riesgo de Inversión</h1>
  <p class="subtitle">Utilice nuestro modelo de IA para evaluar el riesgo potencial de una oferta de inversión antes de crear el contrato.</p>

  <!-- Formulario para introducir los datos -->
  <form [formGroup]="analysisForm" (ngSubmit)="onSubmit()" class="analysis-form">
    <div class="form-grid">
      <div class="form-field">
        <label for="amount">Monto de Inversión</label>
        <input id="amount" type="number" formControlName="amount" min="0" />
        <div *ngIf="amount!.touched && amount!.errors" class="error-text">
          <span *ngIf="amount!.errors?.['required']">El monto es requerido.</span>
          <span *ngIf="amount!.errors?.['min']">El monto no puede ser negativo.</span>
        </div>
        <small *ngIf="usdEquivalent" class="currency-equivalent">
          (Equivalente a ~{{ usdEquivalent | currency:'USD':'symbol':'1.0-0' }} USD)
        </small>
      </div>
      <div class="form-field">
        <label for="currency">Moneda</label>
        <select id="currency" formControlName="currency">
          <option value="USD">USD</option>
          <option value="ARS">ARS</option>
          <option value="CNY">CNY</option>
          <option value="EUR">EUR</option>
        </select>
        <div *ngIf="currency!.invalid && currency!.touched && currency!.errors" class="error-text">
          La moneda es requerida.
        </div>
      </div>
      <div class="form-field">
        <label for="profit1Year">Ganancia 1 Año (%)</label>
        <input id="profit1Year" type="number" formControlName="profit1Year" min="0" max="99" />
        <div *ngIf="profit1Year!.touched && profit1Year!.errors" class="error-text">
          <span *ngIf="profit1Year!.errors?.['required']">La ganancia es requerida.</span>
          <span *ngIf="profit1Year!.errors?.['min'] || profit1Year!.errors?.['max']">El valor debe estar entre 0 y 99.</span>
        </div>
      </div>
      <div class="form-field">
        <label for="profit2Years">Ganancia 2 Años (%)</label>
        <input id="profit2Years" type="number" formControlName="profit2Years" min="0" max="99" />
        <div *ngIf="profit2Years!.touched && profit2Years!.errors" class="error-text">
          <span *ngIf="profit2Years!.errors?.['required']">La ganancia es requerida.</span>
          <span *ngIf="profit2Years!.errors?.['min'] || profit2Years!.errors?.['max']">El valor debe estar entre 0 y 99.</span>
        </div>
      </div>
      <div class="form-field">
        <label for="profit3Years">Ganancia 3 Años (%)</label>
        <input id="profit3Years" type="number" formControlName="profit3Years" min="0" max="99" />
        <div *ngIf="profit3Years!.touched && profit3Years!.errors" class="error-text">
          <span *ngIf="profit3Years!.errors?.['required']">La ganancia es requerida.</span>
          <span *ngIf="profit3Years!.errors?.['min'] || profit3Years!.errors?.['max']">El valor debe estar entre 0 y 99.</span>
        </div>
      </div>
    </div>
    <button type="submit" [disabled]="isLoading">
      {{ isLoading ? 'Analizando...' : 'Calcular Riesgo' }}
    </button>
  </form>
</div>

<!-- Sección de Resultados -->
<div id="results" *ngIf="analysisResult && !isLoading" class="results-container">

  <!-- 1. Cabecera Principal -->
  <header class="report-header" [ngClass]="'risk-bg-' + (analysisResult.riskCategory | lowercase)">
    <h2 class="risk-category">Riesgo {{ analysisResult.riskCategory }}</h2>
    <p class="risk-confidence">
      Confianza del Análisis: {{ analysisResult.confidenceScore }}%
      <span class="tooltip-container">
        <i class="pi pi-info-circle info-icon"></i>
        <span class="tooltip tooltip-bottom">
          <strong>¿Qué es la "Confianza del Análisis"?</strong><br>
          Este porcentaje no es la probabilidad de que el proyecto falle. Representa qué tan seguro está nuestro modelo de IA de su propia predicción (ej. el % de "expertos" que votaron por este resultado).
          Una confianza alta (ej. 95%) indica un consenso muy fuerte.
        </span>
      </span>
    </p>
  </header>

  <!-- ✅ NUEVA SECCIÓN DE ALERTA CRÍTICA -->
  <div *ngIf="criticalAlert" class="critical-alert">
    <h3><i class="pi pi-exclamation-triangle" style="font-size: 1.2rem; margin-right: 0.5rem;"></i>Alerta de Riesgo Crítico</h3>
    <p>
      El riesgo es <strong>{{ criticalAlert.riskCategory }}</strong> principalmente porque {{ criticalAlert.article }} <strong>{{ criticalAlert.criticalFactor.factorName }}</strong> es <strong>{{ criticalAlert.explanation }}</strong>.
    </p>
    <p>
      Nuestro modelo considera esto una señal de alerta que <strong>tiene prioridad sobre los otros indicadores positivos</strong> (como la alta rentabilidad).
    </p>
  </div>

  <!-- 2. Resumen de Inversión y Proyecto -->
  <section class="summary-grid">
    <div class="summary-card">
      <span class="summary-label">Monto a Invertir</span>
      <span class="summary-value">{{ analysisResult.investmentAmount | currency:analysisResult.investmentCurrency:'symbol':'1.2-2' }}</span>
    </div>
    <div class="summary-card">
      <span class="summary-label">
        Meta del Proyecto
        <span class="tooltip-container">
          <i class="pi pi-info-circle info-icon"></i>
          <span class="tooltip tooltip-right">
            <strong>Presupuesto en Dólares (USD)</strong><br />
            La meta de financiación del proyecto siempre se expresa en dólares (USD), independientemente de la moneda en la que inviertas. Tus ganancias, sin embargo, las recibirás en la moneda de tu inversión.
          </span>
        </span>
      </span>
      <span class="summary-value">{{ analysisResult.budgetGoal | currency:'USD':'symbol':'1.0-0' }}</span>
    </div>
    <div class="summary-card">
      <span class="summary-label">
        Ritmo de Financiación
        <span class="tooltip-container">
          <i class="pi pi-info-circle info-icon"></i>
          <span class="tooltip tooltip-right">
            <strong>¿Qué es el "Ritmo de Financiación"?</strong><br />
            Compara el % de dinero recaudado con el % de tiempo transcurrido.
            Un ritmo &gt; 1 es positivo (más rápido de lo esperado), mientras que un ritmo &lt; 1 es negativo (más lento de lo esperado).
          </span>
        </span>
      </span>
      <span class="summary-value pace" [ngClass]="{'positive': analysisResult.fundingPace >= 1, 'negative': analysisResult.fundingPace < 1}">
        {{ analysisResult.fundingPace | number:'1.2-2' }}
      </span>
    </div>
    <div class="summary-card">
      <span class="summary-label">Fin de Campaña de Financiación</span>
      <span class="summary-value">{{ analysisResult.fundingEndDate | date:'dd/MM/yyyy' }}</span>
    </div>
  </section>

  <!-- Barras de Progreso -->
  <div class="progress-section">
    <h4>Progreso de Financiación ({{ analysisResult.currentGoal | currency:'USD':'symbol':'1.0-0' }})</h4>
    <div class="progress-bar-wrapper">
      <div class="progress-bar funding-bar" [style.width.%]="analysisResult.fundingPercentage" [title]="(analysisResult.fundingPercentage | number:'1.0-2') + '%'">
        <span>{{ analysisResult.fundingPercentage | number:'1.0-1' }}%</span>
      </div>
    </div>
  </div>

  <div class="progress-section">
    <h4>Cronograma del Proyecto</h4>
    <div class="progress-bar-wrapper">
      <div class="progress-bar time-bar" [style.width.%]="analysisResult.timeElapsedPercentage" [title]="(analysisResult.timeElapsedPercentage | number:'1.0-1') + '% transcurrido'">
        <span>{{ analysisResult.timeElapsedPercentage | number:'1.0-1' }}%</span>
      </div>
    </div>
    <div class="timeline-details">
      <div class="timeline-point">
        <span class="timeline-label">Inicio Financiación</span>
        <strong class="timeline-date">{{ analysisResult.fundingStartDate | date:'dd/MM/yyyy' }}</strong>
      </div>
      <div class="timeline-point">
        <span class="timeline-label">Fin Financiación / Inicio Desarrollo</span>
        <strong class="timeline-date">{{ analysisResult.fundingEndDate | date:'dd/MM/yyyy' }}</strong>
      </div>
      <div *ngIf="analysisResult.estimatedProjectEndDate" class="timeline-point">
        <span class="timeline-label">Fin Proyecto (Estimado)</span>
        <strong class="timeline-date">{{ analysisResult.estimatedProjectEndDate | date:'dd/MM/yyyy' }}</strong>
      </div>
    </div>
  </div>

  <hr>

  <!-- 3. Factores Clave del Análisis -->
  <div class="title-with-tooltip">
    <h3>Factores Clave del Análisis</h3>
    <span class="tooltip-container">
      <i class="pi pi-info-circle info-icon"></i>
      <span class="tooltip tooltip-right large">
        <strong>¿Cómo leer la "Importancia"?</strong><br /><br />
        Mide la influencia de un factor en el resultado promedio.
        <br /><br />
        Sin embargo, un solo factor en estado <strong>"Negativo"</strong> puede ser una alerta crítica que anule a los demás, sin importar su % de importancia.
      </span>
    </span>
  </div>

  <div class="factors-grid">
    <div *ngFor="let factor of analysisResult.analysisFactors" class="factor-card"
         [ngClass]="'border-' + factor.factorAssessment.toLowerCase()">
      <div class="factor-header">
        <h4 class="factor-name">{{ factor.factorName }}</h4>
        <span class="assessment-badge" [ngClass]="factor.factorAssessment.toLowerCase()">{{ factor.factorAssessment }}</span>
      </div>
      <p class="factor-value">{{ factor.factorValue }}</p>
      <div *ngIf="factor.importancePercentage > 0" class="importance-section" title="Peso de este factor en el análisis de riesgo">
        <i class="fas fa-balance-scale-right"></i>
        <span>Importancia: <strong>{{ factor.importancePercentage | number:'1.0-1' }}%</strong></span>
      </div>
      <p class="factor-description">{{ factor.factorDescription }}</p>
    </div>
  </div>

  <hr>

  <!-- 4. Proyecciones y Gráfico de Riesgo -->
  <div class="financial-details-grid">
    <!-- Columna Izquierda - Proyecciones -->
    <div class="projections-card">
      <h3>Proyección de Ganancias</h3>
      <table>
        <thead>
          <tr>
            <th>Plazo</th>
            <th>Ganancia</th>
            <th>Retorno Total</th>
            <th>
              APY
              <span class="tooltip-container">
                <i class="pi pi-info-circle info-icon"></i>
                <span class="tooltip tooltip-left">
                  <strong>¿Qué es el APY (Tasa de Rendimiento Anual)?</strong><br />
                  Es la tasa de ganancia estandarizada a un año.
                  Sirve para comparar fácilmente la rentabilidad de esta inversión con otras opciones del mercado (como un plazo fijo).
                </span>
              </span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let proj of analysisResult.profitProjections">
            <td>{{ proj.term }}</td>
            <td>{{ proj.profitAmount | currency:analysisResult.investmentCurrency:'symbol':'1.2-2' }}</td>
            <td>{{ proj.totalReturn | currency:analysisResult.investmentCurrency:'symbol':'1.2-2' }}</td>
            <td><strong>{{ proj.apy }}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Columna Derecha - Gráfico -->
    <div class="risk-composition-card">
      <div class="title-with-tooltip">
        <h3>Composición del Riesgo</h3>
        <span class="tooltip-container">
          <i class="pi pi-info-circle info-icon"></i>
          <span class="tooltip tooltip-left large">
            <strong>¿Cómo leer este gráfico?</strong><br />
            La <strong>Puntuación Total (Máx. 300)</strong> es la suma del riesgo de cada factor. Los <strong>Factores de Riesgo (0-100 cada uno)</strong> te muestran cuál es el principal punto de atención. Una puntuación alta en un factor (ej. "Progreso") significa que ese es el mayor contribuyente al riesgo total.
          </span>
        </span>
      </div>
      <p class="chart-description">
        Este gráfico desglosa la contribución de cada factor al riesgo total. Una porción más grande indica que ese factor tiene un mayor peso en la composición del riesgo.
      </p>
      <div class="chart-container">
        <ngx-charts-advanced-pie-chart
  [results]="analysisResult.riskChartData"
  [scheme]="colorScheme"
  [gradient]="true"
  [animations]="true"
  (select)="onSelect($event)"
  [valueFormatting]="valueFormatting"
  [percentageFormatting]="percentageFormatting">
</ngx-charts-advanced-pie-chart>
      </div>
    </div>
  </div>

</div>

<!-- Manejo de Errores -->
<div *ngIf="errorMessage" class="error-message">
  {{ errorMessage }}
</div>
