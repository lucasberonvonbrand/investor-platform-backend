<!-- src/app/features/estudiantes/estudiantes.component.html -->
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<!-- ===== Dialog de DETALLE (solo lectura) ===== -->
<p-dialog
  [(visible)]="showDetail"
  [modal]="true"
  [style]="{ width: '900px' }"
  [breakpoints]="{ '1200px':'80vw', '960px':'90vw', '640px':'95vw' }"
  [contentStyle]="{ 'max-height':'75vh', 'overflow':'auto' }"
  [maximizable]="true"
  [dismissableMask]="true"
  header="Detalle de estudiante">

  <ng-container *ngIf="selected">
    <!-- Encabezado -->
    <div class="flex items-center gap-4 mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
      <img *ngIf="selected.photoUrl"
           [src]="selected.photoUrl" alt="foto"
           class="w-16 h-16 rounded-full object-cover border-2 border-primary-500" />
      <p-avatar *ngIf="!selected.photoUrl" [label]="selected.username.charAt(0).toUpperCase()" size="xlarge" shape="circle"></p-avatar>
      <div>
        <div class="text-xl font-bold text-gray-800 dark:text-gray-100">{{ selected.firstName }} {{ selected.lastName }}</div>
        <div class="text-md text-gray-500 dark:text-gray-400">{{ selected.email }}</div>
        <div class="text-sm text-gray-500 dark:text-gray-400">@{{ selected.username }} (ID: {{ selected.id }})</div>
      </div>
    </div>

    <!-- Datos Personales y Académicos -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm">
      <h3 class="md:col-span-2 text-lg font-semibold border-b pb-2 mb-2">Datos Personales</h3>
      <div><strong>DNI:</strong> {{ selected.dni || '—' }}</div>
      <div><strong>Teléfono:</strong> {{ selected.phone || '—' }}</div>
      <div><strong>Fecha de Nacimiento:</strong> {{ selected.dateOfBirth | date:'dd/MM/yyyy' }}</div>
      <div class="md:col-span-2"><strong>LinkedIn:</strong> <a *ngIf="selected.linkedinUrl" [href]="selected.linkedinUrl" target="_blank" rel="noopener" class="text-primary-500 hover:underline">{{ selected.linkedinUrl }}</a><span *ngIf="!selected.linkedinUrl">—</span></div>
      <div class="md:col-span-2"><strong>Descripción:</strong> <p class="mt-1 opacity-80">{{ selected.description || '—' }}</p></div>
    </div>

    <p-divider></p-divider>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm">
      <h3 class="md:col-span-2 text-lg font-semibold border-b pb-2 mb-2">Datos Académicos</h3>
      <div><strong>Universidad:</strong> {{ selected.university || '—' }}</div>
      <div><strong>Carrera:</strong> {{ selected.career || '—' }}</div>
      <div><strong>Estado de la Carrera:</strong> {{ getDegreeStatusLabel(selected.degreeStatus) }}</div>
    </div>

    <p-divider></p-divider>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm">
      <h3 class="md:col-span-2 text-lg font-semibold border-b pb-2 mb-2">Dirección</h3>
      <div class="md:col-span-2" *ngIf="selected.address; else noAddr">
        {{ selected.address.street }} {{ selected.address.number }}, {{ selected.address.city }} ({{ selected.address.postalCode }}), {{ selected.address.province }}
      </div>
      <ng-template #noAddr><div>—</div></ng-template>
    </div>

    <p-divider></p-divider>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-3 text-sm">
      <h3 class="col-span-full text-lg font-semibold border-b pb-2 mb-2">Estado de la Cuenta</h3>
      <div class="flex items-center gap-2">
        <i class="pi" [ngClass]="selected.enabled ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-500'"></i>
        <span>Habilitado</span>
      </div>
      <div class="flex items-center gap-2">
        <i class="pi" [ngClass]="selected.accountNotExpired ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-500'"></i>
        <span>No Expirada</span>
      </div>
      <div class="flex items-center gap-2">
        <i class="pi" [ngClass]="selected.accountNotLocked ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-500'"></i>
        <span>No Bloqueada</span>
      </div>
      <div class="flex items-center gap-2">
        <i class="pi" [ngClass]="selected.credentialNotExpired ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-500'"></i>
        <span>Credencial Válida</span>
      </div>
    </div>
  </ng-container>
</p-dialog>

<!-- ===== Dialogo CREAR / EDITAR ===== -->
<p-dialog [(visible)]="showDialog" [modal]="true"
          [style]="{ width: '980px' }"
          [breakpoints]="{ '1200px':'85vw','960px':'92vw','640px':'96vw' }"
          [contentStyle]="{ 'max-height':'78vh','overflow':'auto' }"
          [maximizable]="true"
          [dismissableMask]="true"
          [draggable]="false"
          [closable]="true"
          (onHide)="onDialogHide()"
          [header]="isEdit ? 'Editar estudiante' : 'Nuevo estudiante'">

  <!-- Si estamos creando, mostramos el formulario completo de registro -->
  <ng-container *ngIf="!isEdit">
    <app-student-form [isModal]="true" (userCreated)="handleUserCreation()"></app-student-form>
  </ng-container>
  <!-- Si estamos editando, mantenemos el formulario simple de edición -->
  <ng-container *ngIf="isEdit">
    <p-divider class="my-4"></p-divider>

    <form #frm="ngForm" (ngSubmit)="save(frm)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Usuario -->
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Usuario <span class="text-red-500">*</span></label>
        <input pInputText name="username" [(ngModel)]="formModel.username" required />
      </div>

      <!-- Email -->
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Email <span class="text-red-500">*</span></label>
        <input pInputText name="email" [(ngModel)]="formModel.email" required email />
      </div>

      <!-- Password -->
      <div class="col-span-2 sm:col-span-1" *ngIf="!isEdit">
        <label class="block mb-1">
          {{ isEdit ? 'Password (dejar vacío para no cambiar)' : 'Password' }}
          <span *ngIf="!isEdit" class="text-red-500">*</span>
        </label>
        <p-password
          [feedback]="false"
          [toggleMask]="true"
          styleClass="w-full"
          inputStyleClass="w-full"
          name="password"
          [(ngModel)]="formModel.password"
          [required]="!isEdit">
        </p-password>
      </div>

      <!-- Roles -->
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Roles</label>
        <p-multiSelect
          [options]="availableRoles"
          optionLabel="role"
          placeholder="Seleccioná roles"
          [(ngModel)]="selectedRoles"
          name="roles"
          [filter]="true"
          [showClear]="true"
          display="chip">
          <ng-template let-opt pTemplate="item">
            <div class="flex items-center gap-2">
              <span class="pi pi-tag"></span>
              <span>{{ opt.role }}</span>
            </div>
          </ng-template>
        </p-multiSelect>
      </div>

      <p-divider class="col-span-2 my-2"></p-divider>

      <!-- Datos Personales -->
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Nombre <span class="text-red-500">*</span></label>
        <input pInputText name="firstName" [(ngModel)]="formModel.firstName" required pattern="^[A-Za-zÀ-ÿ ]+$" />
      </div>
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Apellido <span class="text-red-500">*</span></label>
        <input pInputText name="lastName" [(ngModel)]="formModel.lastName" required pattern="^[A-Za-zÀ-ÿ ]+$" />
      </div>
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">DNI <span class="text-red-500">*</span></label>
        <input pInputText name="dni" [(ngModel)]="formModel.dni" required pattern="^[0-9]+$" maxlength="8" />
      </div>
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Teléfono</label>
        <input pInputText name="phone" [(ngModel)]="formModel.phone" />
      </div>
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Fecha de Nacimiento</label>
        <input pInputText type="date" name="dateOfBirth" [(ngModel)]="formModel.dateOfBirth" />
      </div>
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">LinkedIn</label>
        <input pInputText name="linkedinUrl" [(ngModel)]="formModel.linkedinUrl" />
      </div>

      <p-divider class="col-span-2 my-2"></p-divider>

      <!-- Datos Académicos -->
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Universidad</label>
        <select
          name="university"
          [(ngModel)]="formModel.university"
          class="w-full p-3 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600">
          <option *ngFor="let uni of universityOptions" [value]="uni.value">{{ uni.label }}</option>
        </select>
      </div>
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Carrera</label>
        <input pInputText name="career" [(ngModel)]="formModel.career" />
      </div>
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Estado de la Carrera</label>
        <select
          name="degreeStatus"
          [(ngModel)]="formModel.degreeStatus"
          class="w-full p-3 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600">
          <option *ngFor="let status of degreeStatusOptions" [value]="status.value">{{ status.label }}</option>
        </select>
      </div>

      <!-- Flags -->
      <div class="col-span-2 grid grid-cols-2 sm:grid-cols-3 gap-3 items-center">
        <div class="flex items-center gap-2">
          <p-checkbox inputId="enabled" name="enabled" [(ngModel)]="formModel.enabled" [binary]="true"></p-checkbox>
          <label for="enabled">Habilitado</label>
        </div>

        <div class="flex items-center gap-2">
          <p-checkbox inputId="accountNotExpired" name="accountNotExpired" [(ngModel)]="formModel.accountNotExpired" [binary]="true"></p-checkbox>
          <label for="accountNotExpired">Cuenta no expirada</label>
        </div>

        <div class="flex items-center gap-2">
          <p-checkbox inputId="accountNotLocked" name="accountNotLocked" [(ngModel)]="formModel.accountNotLocked" [binary]="true"></p-checkbox>
          <label for="accountNotLocked">No bloqueada</label>
        </div>

        <div class="flex items-center gap-2">
          <p-checkbox inputId="credentialNotExpired" name="credentialNotExpired" [(ngModel)]="formModel.credentialNotExpired" [binary]="true"></p-checkbox>
          <label for="credentialNotExpired">Credencial no expirada</label>
        </div>
      </div>

      <p-divider class="my-4"></p-divider>

      <!-- Footer -->
      <div class="col-span-2 flex justify-end gap-2 mt-2">
        <button pButton type="button" label="Cancelar" class="p-button-text" (click)="showDialog=false"></button>
        <button pButton type="submit" label="Guardar" icon="pi pi-check" [disabled]="frm.invalid || loading"></button>
      </div>
    </form>
  </ng-container>
</p-dialog>

<!-- ===== Toolbar (Agregar + Buscador) ===== -->
<p-toolbar class="mb-3">
  <div class="p-toolbar-group-left">
    <button pButton label="Agregar nuevo" icon="pi pi-plus" (click)="openNew()"></button>
    <p-selectButton
      class="ml-4"
      [options]="filterStatusOptions"
      [(ngModel)]="currentFilter"
      optionLabel="label"
      optionValue="value"
      (onChange)="onFilterChange()">
    </p-selectButton>
  </div>

  <div class="p-toolbar-group-right">
    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input
        pInputText
        type="text"
        placeholder="Buscar..."
        (input)="dt.filterGlobal($any($event.target).value, 'contains')" />
    </span>
  </div>
</p-toolbar>

<!-- ===== Tabla principal ===== -->
<p-card header="Estudiantes" class="pp-table">
  <p-table
    #dt
    [value]="filteredStudents"
    [loading]="loading"
    dataKey="id"
    [rowHover]="true"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[5,10,25,50]"
    [globalFilterFields]="['username','email']"
    responsiveLayout="scroll">

    <ng-template pTemplate="header">
      <tr>
        <th style="width:80px">ID</th>
        <th>Usuario</th>
        <th>Email</th>
        <th style="width:220px; text-align:center">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-row>
      <tr>
        <td class="text-right">{{ row.id }}</td>
        <td>{{ row.username }}</td>
        <td>{{ row.email }}</td>

        <td class="text-center whitespace-nowrap">
          <div class="flex items-center justify-center gap-1">
            <button pButton type="button" pTooltip="Ver" icon="pi pi-eye" [text]="true" [rounded]="true" [size]="'small'"
              (click)="onView(row)"></button>

            <button pButton type="button" pTooltip="Editar" icon="pi pi-pencil" severity="success" [text]="true" [rounded]="true" [size]="'small'"
              (click)="edit(row)"></button>

            <button *ngIf="!row.enabled" pButton type="button" pTooltip="Activar"    icon="pi pi-check-circle" severity="success" [text]="true" [rounded]="true" [size]="'small'"
              (click)="toggleActive(row, true)"></button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>
