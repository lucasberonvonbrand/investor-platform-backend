<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<!-- ===== Detalle ===== -->
<p-dialog
  [(visible)]="showDetail"
  [modal]="true"
  [style]="{ width: '900px' }"
  [breakpoints]="{ '1200px':'80vw', '960px':'90vw', '640px':'95vw' }"
  [contentStyle]="{ 'max-height':'75vh', 'overflow':'auto' }"
  [maximizable]="true"
  [dismissableMask]="true"
  header="Detalle de investor">
  <ng-container *ngIf="selected">
    <!-- Encabezado -->
    <div class="flex items-center gap-4 mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
      <img *ngIf="selected.photoUrl" [src]="selected.photoUrl" alt="logo" class="w-16 h-16 rounded-full object-cover border-2 border-primary-500" />
      <p-avatar *ngIf="!selected.photoUrl" icon="pi pi-building" size="xlarge" shape="circle"></p-avatar>
      <div>
        <div class="text-xl font-bold text-gray-800 dark:text-gray-100">{{ selected.contactPerson }}</div>
        <div class="text-md text-gray-500 dark:text-gray-400">{{ selected.email }}</div>
        <div class="text-sm text-gray-500 dark:text-gray-400">@{{ selected.username }} (ID: {{ selected.id }})</div>
      </div>
    </div>

    <!-- Datos de la Empresa y Contacto -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm">
      <h3 class="md:col-span-2 text-lg font-semibold border-b pb-2 mb-2">Datos de Contacto</h3>
      <div><strong>CUIT:</strong> {{ selected.cuit || '—' }}</div>
      <div><strong>Teléfono:</strong> {{ selected.phone || '—' }}</div>
      <div class="md:col-span-2">
        <strong>Sitio Web:</strong>
        <a *ngIf="selected.webSite" [href]="selected.webSite" target="_blank" rel="noopener" class="text-primary-500 hover:underline ml-2">{{ selected.webSite }}</a>
        <span *ngIf="!selected.webSite"> —</span>
      </div>
    </div>

    <p-divider></p-divider>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm">
      <h3 class="md:col-span-2 text-lg font-semibold border-b pb-2 mb-2">Dirección</h3>
      <div class="md:col-span-2" *ngIf="selected.address; else noAddr">
        {{ selected.address.street }} {{ selected.address.number }}, {{ selected.address.city }} ({{ selected.address.postalCode }}), {{ selected.address.province }}
      </div>
      <ng-template #noAddr><div>—</div></ng-template>
    </div>

    <p-divider></p-divider>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-3 text-sm">
      <h3 class="col-span-full text-lg font-semibold border-b pb-2 mb-2">Estado de la Cuenta</h3>
      <div class="flex items-center gap-2"><i class="pi" [ngClass]="selected.enabled ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-500'"></i><span>Habilitado</span></div>
      <div class="flex items-center gap-2"><i class="pi" [ngClass]="selected.accountNotExpired ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-500'"></i><span>No Expirada</span></div>
      <div class="flex items-center gap-2"><i class="pi" [ngClass]="selected.accountNotLocked ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-500'"></i><span>No Bloqueada</span></div>
      <div class="flex items-center gap-2"><i class="pi" [ngClass]="selected.credentialNotExpired ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-500'"></i><span>Credencial Válida</span></div>
    </div>
  </ng-container>
</p-dialog>
<!-- ===== Diálogo CREAR / EDITAR ===== -->
<p-dialog [(visible)]="showDialog" [modal]="true"
          [style]="{ width: '980px' }"
          [breakpoints]="{ '1200px':'85vw','960px':'92vw','640px':'96vw' }"
          [contentStyle]="{ 'max-height':'78vh','overflow':'auto' }"
          [maximizable]="true"
          [dismissableMask]="true"
          [draggable]="false"
          [closable]="true"
          (onHide)="onDialogHide()"
          [header]="isEdit ? 'Editar investor' : 'Nuevo investor'">

  <!-- Si estamos creando, mostramos el formulario completo de registro -->
  <ng-container *ngIf="!isEdit">
    <app-investor-form [isModal]="true" (userCreated)="handleUserCreation()"></app-investor-form>
  </ng-container>
  <!-- Si estamos editando, mantenemos el formulario simple de edición -->
  <ng-container *ngIf="isEdit">
    <p-divider class="my-4"></p-divider>

    <form #frm="ngForm" (ngSubmit)="save(frm)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Usuario -->
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Usuario <span class="text-red-500">*</span></label>
        <input pInputText name="username" [(ngModel)]="formModel.username" required />
      </div>

      <!-- Email -->
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Email <span class="text-red-500">*</span></label>
        <input pInputText name="email" [(ngModel)]="formModel.email" required email />
      </div>

      <!-- CUIT -->
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">CUIT <span class="text-red-500">*</span></label>
        <input pInputText name="cuit" [(ngModel)]="formModel.cuit" required pattern="^[0-9]+$" maxlength="11" />
      </div>

      <!-- Contacto -->
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Persona de Contacto <span class="text-red-500">*</span></label>
        <input pInputText name="contactPerson" [(ngModel)]="formModel.contactPerson" required pattern="^[A-Za-zÀ-ÿ ]+$" />
      </div>

      <!-- Teléfono -->
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Teléfono</label>
        <input pInputText name="phone" [(ngModel)]="formModel.phone" />
      </div>

      <!-- Web -->
      <div class="col-span-2 sm:col-span-1">
        <label class="block mb-1">Sitio web</label>
        <input pInputText name="webSite" [(ngModel)]="formModel.webSite" />
      </div>

      <p-divider class="col-span-2 my-2"></p-divider>

      <!-- Dirección -->
      <div class="col-span-2">
        <label class="block mb-1 font-semibold">Dirección</label>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 border p-3 rounded-lg">
          <div class="col-span-2 md:col-span-1">
            <label class="block mb-1 text-sm">Calle</label>
            <input pInputText placeholder="Calle" [(ngModel)]="formModel.address.street" name="street" />
          </div>
          <div>
            <label class="block mb-1 text-sm">Número</label>
            <input pInputText placeholder="Número" [(ngModel)]="formModel.address.number" name="number" type="number" />
          </div>
          <div>
            <label class="block mb-1 text-sm">Cód. Postal</label>
            <input pInputText placeholder="CP" [(ngModel)]="formModel.address.postalCode" name="postalCode" />
          </div>
          <div>
            <label class="block mb-1 text-sm">Ciudad</label>
            <input pInputText placeholder="Ciudad" [(ngModel)]="formModel.address.city" name="city" />
          </div>
          <div>
            <label class="block mb-1 text-sm">Provincia</label>
            <input pInputText placeholder="Provincia" [(ngModel)]="formModel.address.province" name="province" />
          </div>
        </div>
      </div>

      <p-divider class="col-span-2 my-2"></p-divider>

      <!-- Flags -->
      <div class="col-span-2 grid grid-cols-2 sm:grid-cols-3 gap-3 items-center">
        <div class="flex items-center gap-2">
          <p-checkbox inputId="enabled" name="enabled" [(ngModel)]="formModel.enabled" [binary]="true"></p-checkbox>
          <label for="enabled">Habilitado</label>
        </div>
        <div class="flex items-center gap-2">
          <p-checkbox inputId="accountNotExpired" name="accountNotExpired" [(ngModel)]="formModel.accountNotExpired" [binary]="true"></p-checkbox>
          <label for="accountNotExpired">Cuenta no expirada</label>
        </div>
        <div class="flex items-center gap-2">
          <p-checkbox inputId="accountNotLocked" name="accountNotLocked" [(ngModel)]="formModel.accountNotLocked" [binary]="true"></p-checkbox>
          <label for="accountNotLocked">No bloqueada</label>
        </div>
        <div class="flex items-center gap-2">
          <p-checkbox inputId="credentialNotExpired" name="credentialNotExpired" [(ngModel)]="formModel.credentialNotExpired" [binary]="true"></p-checkbox>
          <label for="credentialNotExpired">Credencial no expirada</label>
        </div>
      </div>

      <p-divider class="col-span-2 my-4"></p-divider>

      <!-- Footer -->
      <div class="col-span-2 flex justify-end gap-2 mt-2">
        <button pButton type="button" label="Cancelar" class="p-button-text" (click)="showDialog=false"></button>
        <button pButton type="submit" label="Guardar" icon="pi pi-check" [disabled]="frm.invalid || loading"></button>
      </div>
    </form>
  </ng-container>
</p-dialog>

<!-- ===== Toolbar ===== -->
<p-toolbar class="mb-3">
  <div class="p-toolbar-group-left">
    <button pButton label="Agregar nuevo" icon="pi pi-plus" (click)="openNew()"></button>
    <p-selectButton
      class="ml-4"
      [options]="filterStatusOptions"
      [(ngModel)]="currentFilter"
      optionLabel="label"
      optionValue="value"
      (onChange)="onFilterChange()">
    </p-selectButton>
  </div>
  <div class="p-toolbar-group-right">
    <span class="p-input-icon-left">
      <i class="pi pi-search mr-2"></i>
      <input pInputText type="text" placeholder="Buscar..." (input)="dt.filterGlobal($any($event.target).value, 'contains')" />
    </span>
  </div>
</p-toolbar>

<!-- ===== Tabla ===== -->
<p-card header="Investors" class="pp-table">
  <p-table
    #dt
    [value]="filteredInvestors"
    [loading]="loading"
    dataKey="id"
    [rowHover]="true"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[5,10,25,50]"
    [globalFilterFields]="['username','email','cuit','contactPerson','webSite']"
    responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th style="width:80px">ID</th>
        <th>Usuario</th>
        <th>Email</th>
        <th>CUIT</th>
        <th>Contacto</th>
        <th style="width:220px; text-align:center">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-row>
      <tr>
        <td class="text-right">{{ row.id }}</td>
        <td>{{ row.username }}</td>
        <td>{{ row.email }}</td>
        <td>{{ row.cuit || '—' }}</td>
        <td>{{ row.contactPerson || '—' }}</td>

        <!-- Acciones (todas las etiquetas cerradas) -->
        <td class="text-center whitespace-nowrap">
          <div class="flex items-center justify-center gap-1">
            <button
              pButton
              type="button"
              pTooltip="Ver"
              icon="pi pi-eye"
              [text]="true"
              [rounded]="true"
              [size]="'small'"
              (click)="onView(row)">
            </button>

            <button
              pButton
              type="button"
              pTooltip="Editar"
              icon="pi pi-pencil"
              severity="success"
              [text]="true"
              [rounded]="true"
              [size]="'small'"
              (click)="edit(row)">
            </button>

            <button
              *ngIf="!row.enabled"
              pButton
              type="button"
              pTooltip="Activar"
              icon="pi pi-check-circle"
              severity="success"
              [text]="true"
              [rounded]="true"
              [size]="'small'"
              (click)="toggleActive(row, true)">
            </button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>
