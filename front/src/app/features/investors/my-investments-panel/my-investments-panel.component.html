<p-toast></p-toast>

<!-- Toolbar -->
<p-toolbar class="mb-3">
  <div class="p-toolbar-group-left">
    <span class="p-input-icon-left mr-2">
      <i class="pi pi-search"></i>
      <input pInputText type="text" placeholder="Buscar mis inversiones..."
             [(ngModel)]="q" (input)="applyFilters()" />
    </span>
  </div>

  <div class="p-toolbar-group-right flex items-center gap-2">
    <button pButton icon="pi pi-th-large" label="Cards"
            [outlined]="viewMode!=='cards'"
            (click)="viewMode='cards'"></button>
    <button pButton icon="pi pi-table" label="Tabla"
            [outlined]="viewMode!=='table'"
            (click)="viewMode='table'"></button>

    <button pButton label="Refrescar" icon="pi pi-refresh" (click)="reload()" [disabled]="loading"></button>
  </div>
</p-toolbar>

<!-- KPIs -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-3">
  <p-card class="shadow-sm">
    <div class="flex items-center gap-3">
      <span class="pi pi-briefcase text-2xl opacity-80"></span>
      <div><div class="text-xs opacity-70">Proyectos invertidos</div><div class="text-xl font-bold">{{ kpis.total }}</div></div>
    </div>
  </p-card>
  <p-card class="shadow-sm">
    <div class="flex items-center gap-3">
      <span class="pi pi-bolt text-2xl opacity-80"></span>
      <div><div class="text-xs opacity-70">Activos</div><div class="text-xl font-bold">{{ kpis.activos }}</div></div>
    </div>
  </p-card>
  <p-card class="shadow-sm">
    <div class="flex items-center gap-3">
      <span class="pi pi-clock text-2xl opacity-80"></span>
      <div><div class="text-xs opacity-70">Recientes (30d)</div><div class="text-xl font-bold">{{ kpis.recientes }}</div></div>
    </div>
  </p-card>
  <p-card class="shadow-sm">
    <div class="flex items-center gap-3">
      <span class="pi pi-chart-line text-2xl opacity-80"></span>
      <div><div class="text-xs opacity-70">Con financiación</div><div class="text-xl font-bold">{{ kpis.conFinanciacion }}</div></div>
    </div>
  </p-card>
</div>

<!-- ===== Vista principal: CARDS o TABLA ===== -->
<p-card class="mt-4 shadow-sm" header="Mis Inversiones">
  <!-- Cards -->
  <div *ngIf="viewMode==='cards'" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
    <div *ngFor="let row of filtered" class="border rounded-xl p-3 h-full flex flex-col">
      <div class="flex items-start justify-between gap-3">
        <div class="font-semibold text-lg leading-tight">{{ row.project.title }}</div>
      </div>
      <div class="opacity-70 text-sm mt-1 line-clamp-3">{{ row.project.summary || '—' }}</div>
      <div class="mt-2 flex gap-2 flex-wrap">
        <p-tag [value]="row.project.category " [ngStyle]="tagStyle(row.project.category , 0)"></p-tag>
        <p-tag [value]="getInvestmentStatusLabel(row.status)" [ngStyle]="tagStyle(row.status || '—', 1)"></p-tag>
        <p-tag *ngIf="row.project.university" [value]="row.project.university" [ngStyle]="tagStyle(row.project.university, 2)"></p-tag>
      </div>
      <div class="mt-3 flex-1"></div>
      <div class="mt-3 flex items-center justify-between">
        <button pButton type="button" label="Ver" icon="pi pi-eye" (click)="openDetail(row)"></button>
        <span class="text-xs opacity-70" *ngIf="row.project.lastUpdated">Actualizado: {{ row.project.lastUpdated | date:'dd/MM/yyyy' }}</span>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <p-table *ngIf="viewMode==='table'"
    [value]="filtered" [loading]="loading" dataKey="id"
    [rowHover]="true" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,25,50]"
    [globalFilterFields]="['title','summary','category','status','university']"
    responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th style="width:120px">Nro. Inversión</th>
        <th>Título</th>
        <th>Categoría</th>
        <th>Estado</th>
        <th style="width:120px; text-align:center">Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-row>
      <tr>
        <td class="text-right">{{ row.idInvestment }}</td>
        <td>{{ row.project.title }}</td>
        <td><p-tag [value]="row.project.category " [ngStyle]="tagStyle(row.project.category , 0)"></p-tag></td>
        <td><p-tag [value]="getInvestmentStatusLabel(row.status)" [ngStyle]="tagStyle(row.status , 1)"></p-tag></td>
        <td class="text-center">
          <button pButton type="button" pTooltip="Ver" icon="pi pi-eye" [text]="true" [rounded]="true" [size]="'small'"
                  (click)="openDetail(row)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>
