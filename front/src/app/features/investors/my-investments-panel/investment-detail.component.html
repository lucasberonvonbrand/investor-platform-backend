<p-toast></p-toast>

<div class="investment-detail-page">
  <div class="header">
    <p-button icon="pi pi-arrow-left" [text]="true" [rounded]="true" (click)="goBack()" pTooltip="Volver" tooltipPosition="right"></p-button>
    <h1>Detalle de la Inversión</h1>
  </div>

  @if (loading()) {
    <div class="card-skeleton">
      <div class="p-skeleton" style="width: 100%; height: 250px;"></div>
    </div>
  } @else if (investment(); as inv) {
    <div class="content-grid">
      <!-- Columna Izquierda: Detalles del Proyecto -->
      <p-card class="project-card">
        <ng-template pTemplate="header">
          <div class="card-header">
            <h2 class="project-title">{{ inv.project.title }}</h2>
            <p-tag [value]="inv.project.category" severity="info"></p-tag>
          </div>
        </ng-template>

        <div class="project-summary" [innerHTML]="inv.project.summary | safeHtml"></div>

        <div class="project-stats">
          <div class="stat-item">
            <span class="label">Tu Inversión:</span>
            <span class="value amount">{{ inv.amount | currency:inv.currency:'symbol':'1.2-2' }}</span>
          </div>
          <div class="stat-item">
            <span class="label">Estado de la Inversión:</span>
            <span class="value">
              <p-tag [value]="getInvestmentStatusLabel(inv.status)" [severity]="getInvestmentStatusSeverity(inv.status)"></p-tag>
            </span>
          </div>
          <div class="stat-item">
            <span class="label">Fecha de Inversión:</span>
            <span class="value">{{ inv.createdAt | date:'dd/MM/yyyy' }}</span>
          </div>
          <div class="stat-item">
            <span class="label">Monto Recaudado:</span>
            <span class="value amount">{{ inv.project.fundingRaised | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="stat-item">
            <span class="label">Meta de Financiación:</span>
            <span class="value">{{ inv.project.fundingGoal | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
        </div>

        <div class="funding-progress">
          <span class="label">Progreso de Financiación ({{ fundingPercentage() | number:'1.0-2' }}%)</span>
          <!-- Barra de progreso personalizada para sobrefinanciación -->
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-1 flex"
               [pTooltip]="overfundingProgress() > 0 ? '¡Meta superada! La barra verde representa el 100% del objetivo y la azul el excedente recaudado.' : ''"
               tooltipPosition="top">
            <div class="h-2.5 rounded-l-full"
                 [ngClass]="{ 'bg-green-500': fundingProgress() >= 70, 'bg-yellow-400': fundingProgress() < 70, 'rounded-r-full': overfundingProgress() <= 0 }"
                 [style.width.%]="fundingProgress()"></div>
            <!-- Barra de sobrefinanciación -->
            <div *ngIf="overfundingProgress() > 0" class="h-2.5 bg-blue-500 rounded-r-full" [style.width.%]="overfundingProgress()"></div>
          </div>
        </div>

        <ng-template pTemplate="footer">
          <p-button label="Ver Proyecto Completo" icon="pi pi-arrow-right" iconPos="right" styleClass="p-button-link" [routerLink]="['/proyectos-maestro', inv.project.id]"></p-button>
        </ng-template>
      </p-card>

      <!-- Columna Derecha: Ganancias -->
      <div class="earnings-section">
        <p-card>
          <ng-template pTemplate="title">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-chart-line"></i>
              <span>Monitor de Ganancias</span>
            </div>
          </ng-template>

          @if (inv.earnings && inv.earnings.length > 0) {
            <p-table [value]="inv.earnings" styleClass="p-datatable-sm w-full">
              <ng-template pTemplate="header">
                <tr>
                  <th>Fecha de Generación</th>
                  <th class="text-right">Inversión Base</th>
                  <th class="text-right">Tasa de Ganancia</th>
                  <th class="text-right">Monto Ganancia</th>
                  <th>Estado</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-earning>
                <tr>
                  <td>{{ earning.createdAt | date:'dd/MM/yyyy' }}</td>
                  <td class="text-right">{{ earning.baseAmount | currency:earning.currency:'symbol':'1.2-2' }}</td>
                  <td class="text-right">{{ earning.profitRate | percent:'1.2-2' }}</td>
                  <td class="text-right font-semibold">{{ earning.profitAmount | currency:earning.currency:'symbol':'1.2-2' }}</td>
                  <td>
                    <p-tag [value]="getEarningStatusLabel(earning.status)" [severity]="getEarningStatusSeverity(earning.status)"></p-tag>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          } @else {
            <div class="empty-state">
              <!-- Mensaje específico si la inversión fue devuelta o cancelada -->
              @if (inv.status === 'RETURNED' || inv.status === 'CANCELLED' || inv.status === 'NOT_RECEIVED') {
                <i class="pi pi-undo text-blue-500"></i>
                <p>No se generaron ganancias</p>
                <span>Esta inversión fue devuelta o cancelada, por lo que el ciclo finalizó sin generar beneficios.</span>
              }
              <!-- Mensaje genérico para otros casos -->
              @else {
                <i class="pi pi-info-circle"></i>
                <p>Aún no se han generado ganancias para esta inversión.</p>
                <span>Las ganancias se calcularán y mostrarán aquí una vez que el contrato asociado se cierre.</span>
              }
            </div>
          }
        </p-card>
      </div>
    </div>

    <!-- Sección de Proyección de Ganancias a Ancho Completo -->
    <!-- CORRECCIÓN: Solo mostrar proyecciones si el estado de la inversión es apropiado (no cancelado, no devuelto, etc.) -->
    @if (inv.status !== 'RETURNED' && inv.status !== 'CANCELLED' && inv.status !== 'NOT_RECEIVED' && inv.status !== 'PENDING_RETURN') {
      @if (projectionChartData(); as chartData) {
      <p-card class="mt-4">
        <ng-template pTemplate="title">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-chart-bar"></i>
            <span>Proyección de Ganancias</span>
          </div>
        </ng-template>

        <div class="projection-grid">
          <div class="chart-container">
            <p-chart type="line" [data]="chartData" [options]="projectionChartOptions()"></p-chart>
          </div>
          <div class="projection-list">
            @for (ds of chartData.datasets; track ds) {
              @for (item of ds.data; track $index) {
                <div class="projection-item">
                  <!-- CORRECCIÓN: La variable 'projections' no existe aquí. 
                       Calculamos el porcentaje a partir del monto de la inversión y la ganancia proyectada. -->
                  <span class="term">{{ chartData.labels[$index] }} ({{ (item / inv.amount * 100) | number:'1.0-0' }}%)</span>
                  <span class="profit">+{{ item | currency:inv.currency:'':'1.2-2' }} {{ inv.currency }}</span>
                </div>
              }
            }
          </div>
        </div>
      </p-card>
      } @else {
        <p-card class="mt-4">
          <div class="empty-state">
            <i class="pi pi-info-circle"></i>
            <p>No hay proyecciones de ganancias disponibles.</p>
            <span>Las proyecciones se basan en los términos del contrato asociado al proyecto.</span>
          </div>
        </p-card>
      }
    }

  } @else {
    <p-card>
      <div class="empty-state">
        <i class="pi pi-exclamation-triangle"></i>
        <p>No se encontró la inversión</p>
        <span>La inversión que buscas no existe o fue eliminada.</span>
        <p-button label="Volver a Mis Inversiones" styleClass="p-button-text mt-4" (click)="goBack()"></p-button>
      </div>
    </p-card>
  }
</div>