<p-toast></p-toast>

<!-- Estado Vacío: Cuando no hay proyectos -->
<div *ngIf="showEmptyState()" class="flex flex-col items-center justify-center text-center p-8 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg mt-4" @fadeInOut>
  <i class="pi pi-folder-open text-6xl text-gray-400 dark:text-gray-500 mb-4"></i>
  <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-200">Aún no tienes proyectos creados</h2>
  <p class="text-gray-500 dark:text-gray-400 mt-2">¡Es hora de dar el primer paso y compartir tu idea con el mundo!</p>
  <a routerLink="/proyectos" class="mt-6">
    <button pButton label="Crear mi Primer Proyecto" icon="pi pi-plus" class="p-button-warning mt-6"></button>
  </a>
</div>

<!-- Contenido principal: se muestra solo si hay proyectos -->
<div *ngIf="!showEmptyState()" @fadeInOut>
  <!-- Toolbar -->
<p-toolbar class="mb-3">
  <div class="p-toolbar-group-left">
    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input pInputText type="text" placeholder="Buscar mis proyectos..."
             [(ngModel)]="q" (input)="applyFilters()" />
    </span>

    <!-- Select nativo para categoría -->
    <span class="ml-2">
      <select class="p-inputtext p-component" [(ngModel)]="selectedCategory" (change)="applyFilters()">
        <option [ngValue]="''">Todas las categorías</option>
        <option *ngFor="let c of categories" [ngValue]="c">{{ c }}</option>
      </select>
    </span>
  </div>

  <div class="p-toolbar-group-right flex items-center gap-2">
    <button pButton icon="pi pi-th-large" label="Cards"
            [outlined]="viewMode!=='cards'"
            (click)="viewMode='cards'"></button>
    <button pButton icon="pi pi-table" label="Tabla"
            [outlined]="viewMode!=='table'"
            (click)="viewMode='table'"></button>

    <button pButton label="Refrescar" icon="pi pi-refresh" (click)="reload()" [disabled]="loading()"></button>
  </div>
</p-toolbar>

<!-- KPIs -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-3">
  <p-card class="shadow-sm">
    <div class="flex items-center gap-3">
      <span class="pi pi-user text-2xl opacity-80"></span>
      <div><div class="text-xs opacity-70">Mis proyectos</div><div class="text-xl font-bold">{{ kpis.total }}</div></div>
    </div>
  </p-card>
  <p-card class="shadow-sm">
    <div class="flex items-center gap-3">
      <span class="pi pi-bolt text-2xl opacity-80"></span>
      <div><div class="text-xs opacity-70">Activos</div><div class="text-xl font-bold">{{ kpis.activos }}</div></div>
    </div>
  </p-card>
  <p-card class="shadow-sm">
    <div class="flex items-center gap-3">
      <span class="pi pi-clock text-2xl opacity-80"></span>
      <div><div class="text-xs opacity-70">Recientes (30d)</div><div class="text-xl font-bold">{{ kpis.recientes }}</div></div>
    </div>
  </p-card>
  <p-card class="shadow-sm">
    <div class="flex items-center gap-3">
      <span class="pi pi-chart-line text-2xl opacity-80"></span>
      <div><div class="text-xs opacity-70">Con financiación</div><div class="text-xl font-bold">{{ kpis.conFinanciacion }}</div></div>
    </div>
  </p-card>
</div>

<!-- ===== Vista principal: CARDS o TABLA ===== -->
<p-card class="mt-4 shadow-sm" header="Mis Proyectos">
  <!-- Cards -->
  <div *ngIf="viewMode==='cards'" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
    <div *ngFor="let row of filtered"
         class="border rounded-xl p-3 h-full flex flex-col">
      <div class="font-semibold text-lg leading-tight">{{ row.title }}</div>
      <div class="opacity-70 text-sm mt-1 line-clamp-3">{{ row.summary || '—' }}</div>
      <div class="mt-2 flex gap-2 flex-wrap">
        <p-tag [value]="getCategoryLabel(row.category)" [ngStyle]="tagStyle(row.category || '—', 0)"></p-tag>
        <div class="flex items-center gap-1 text-sm">
          <span class="font-semibold">Estado:</span>
          <p-tag [value]="getProjectStatusLabel(row.status)" [ngStyle]="tagStyle(row.status || '—', 1)"></p-tag>
        </div>
        <p-tag *ngIf="row.university" [value]="row.university" [ngStyle]="tagStyle(row.university, 2)"></p-tag>
      </div>
      <div class="mt-3 flex-1"></div>
      <div class="mt-4 border-t pt-3">
        <button pButton type="button" label="Ver Detalles" icon="pi pi-arrow-right" iconPos="right"
                class="w-full p-button-secondary p-button-outlined"
                (click)="openDetail(row)"></button>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <p-table *ngIf="viewMode==='table'"
    [value]="filtered" [loading]="loading()" dataKey="id"
    [rowHover]="true" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,25,50]"
    [globalFilterFields]="['title','summary','category','status']"
    responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th style="width:120px">Número de Proyecto</th>
        <th>Título</th>
        <th>Categoría</th>
        <th>Estado</th>
        <th style="width:160px; text-align:center">Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-row>
      <tr>
        <td class="text-center font-semibold">#{{ row.id }}</td>
        <td>{{ row.title }}</td>
        <td><p-tag [value]="getCategoryLabel(row.category)" [ngStyle]="tagStyle(row.category, 0)"></p-tag></td>
        <td>
          <span class="font-semibold mr-2">Estado:</span>
          <p-tag [value]="getProjectStatusLabel(row.status)" [ngStyle]="tagStyle(row.status || '—', 1)"></p-tag>
        </td>
        <td class="text-center whitespace-nowrap">
          <div class="flex items-center justify-center gap-1">
            <button pButton type="button" pTooltip="Ver" icon="pi pi-eye" [text]="true" [rounded]="true" [size]="'small'" (click)="openDetail(row)"></button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

<!-- Detalle -->
<p-dialog [(visible)]="showDetail" [modal]="true"
          [style]="{ width: '900px' }"
          [breakpoints]="{ '1200px':'80vw', '960px':'90vw', '640px':'95vw' }"
          [contentStyle]="{ 'max-height':'75vh', 'overflow':'auto' }"
          [maximizable]="true" [dismissableMask]="true"
          header="Detalle de mi proyecto">
  <ng-container *ngIf="selected">
    <div class="grid grid-cols-2 gap-3">
      <div class="col-span-2 text-lg font-semibold">{{ selected.title }}</div>
      <div><strong>Categoría:</strong> {{ selected.category || '—' }}</div>
      <div><strong>Estado:</strong> {{ selected.status || '—' }}</div>
      <div><strong>Universidad:</strong> {{ selected.university || '—' }}</div>
      <div><strong>Líder:</strong> {{ selected.owner || '—' }}</div>
      <div class="col-span-2">
        <strong>Resumen:</strong>
        <div class="opacity-80 mt-1">{{ selected.summary || '—' }}</div>
      </div>
      <div class="col-span-2" *ngIf="selected.fundingGoal != null || selected.fundingRaised != null">
        <strong>Financiación:</strong>
        <div class="opacity-80 mt-1">
          Meta: {{ selected.fundingGoal ?? '—' }} · Recaudado: {{ selected.fundingRaised ?? '—' }}
        </div>
      </div>
      <div class="col-span-2 flex gap-2 mt-2">
        <p-tag *ngFor="let t of (selected.tags || []); let i = index" [value]="t" [ngStyle]="tagStyle(t, i)"></p-tag>
      </div>
    </div>
    <p-divider></p-divider>
    <details class="text-xs opacity-70">
      <summary>Ver JSON</summary>
      <pre class="whitespace-pre-wrap">{{ selected | json }}</pre>
    </details>
  </ng-container>
</p-dialog>

</div>
