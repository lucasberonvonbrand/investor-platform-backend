<p-toolbar class="mb-3">
  <div class="p-toolbar-group-left">
    <button pButton icon="pi pi-arrow-left" label="Volver" (click)="goBack()"></button>
  </div>

  <div class="p-toolbar-group-right flex items-center gap-2">
    <button pButton icon="pi pi-user" label="Contactar" (click)="openContactDialog()" [disabled]="!project()"></button>
  </div>
</p-toolbar>

<p-card class="shadow-sm">
  <ng-container *ngIf="project(); else loadingTpl">
    <!-- Título y Resumen -->
    <div class="mb-4">
      <h2 class="text-2xl font-semibold">{{ project()?.title ?? '—' }}</h2>
      <p class="opacity-70 mt-1">{{ project()?.summary ?? '—' }}</p>
    </div>

    <!-- Metadatos del Proyecto -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
      <div>
        <div class="font-semibold text-gray-500 dark:text-gray-400">Líder del Proyecto</div>
        <div class="text-gray-800 dark:text-gray-100">{{ project()?.owner ?? 'No asignado' }}</div>
      </div>
      <div>
        <div class="font-semibold text-gray-500 dark:text-gray-400">Categoría</div>
        <div><p-tag [value]="project()?.category ?? '—'" [ngStyle]="tagStyle(project()?.category ?? '—', 0)"></p-tag></div>
      </div>
      <div>
        <div class="font-semibold text-gray-500 dark:text-gray-400 flex items-center gap-2">
          <span>Estado</span>
          <i class="pi pi-info-circle text-sm cursor-pointer"
             pTooltip="El estado del proyecto avanza automáticamente. Cambiará a 'En Progreso' cuando se confirme la primera inversión, y a 'Completado' al alcanzar la meta de financiación."
             tooltipPosition="top"></i>
        </div>
        <div><p-tag [value]="getProjectStatusLabel(project()?.status)" [ngStyle]="tagStyle(project()?.status ?? '—', 1)"></p-tag></div>
      </div>
      <div *ngIf="project()?.university as uni">
        <div class="font-semibold text-gray-500 dark:text-gray-400">Universidad</div>
        <div><p-tag [value]="uni" [ngStyle]="tagStyle(uni, 2)"></p-tag></div>
      </div>
      <div *ngIf="project()?.startDate as date">
        <div class="font-semibold text-gray-500 dark:text-gray-400">Fecha de Inicio</div>
        <div class="text-gray-800 dark:text-gray-100">{{ date | date:'dd/MM/yyyy' }}</div>
      </div>
      <div *ngIf="project()?.estimatedEndDate as date">
        <div class="font-semibold text-gray-500 dark:text-gray-400">Fecha Fin Estimada</div>
        <div class="text-gray-800 dark:text-gray-100">{{ date | date:'dd/MM/yyyy' }}</div>
      </div>
      <div class="md:col-span-2" *ngIf="project()?.fundingGoal != null || project()?.fundingRaised != null">
        <div class="font-semibold text-gray-500 dark:text-gray-400">Financiación</div>
        <div class="flex items-baseline gap-2">
          <span class="text-lg font-bold text-primary-500">{{ project()?.fundingRaised | currency:'USD':'symbol':'1.0-0' }}</span>
          <span class="text-gray-500">de {{ project()?.fundingGoal | currency:'USD':'symbol':'1.0-0' }}</span>
        </div>
        <p-progressBar [value]="fundingProgress()" [showValue]="false" styleClass="mt-2 h-2"
                       [ngClass]="{
                         'progress-low': fundingProgress() < 33,
                         'progress-medium': fundingProgress() >= 33 && fundingProgress() < 70,
                         'progress-high': fundingProgress() >= 70
                       }">
        </p-progressBar>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4 border-t pt-4">
      <p-card>
        <div class="font-semibold mb-2">Equipo</div>
        <ul class="list-disc ml-4">
          <li *ngFor="let s of team">
            {{ s.name }} <span class="opacity-60" *ngIf="s.email">— {{ s.email }}</span>
          </li>
          <li *ngIf="team.length === 0">—</li>
        </ul>
      </p-card>

      <p-card>
        <div class="font-semibold mb-2">Documentación del Proyecto</div>
        <div class="text-center opacity-60 p-4 border-2 border-dashed rounded-lg">
          <i class="pi pi-inbox text-2xl mb-2"></i>
          <div>Próximamente: aquí se mostrarán los documentos adjuntos.</div>
        </div>
      </p-card>
    </div>
  </ng-container>

  <ng-template #loadingTpl>
    <div class="flex items-center gap-2"><i class="pi pi-spin pi-spinner"></i> Cargando proyecto...</div>
  </ng-template>
</p-card>

<!-- Botón "Iniciar Contrato" central y prominente (solo inversor, si el formulario no está abierto) -->
<div *ngIf="isInvestor() && !accordionOpen()" class="flex justify-center items-center gap-3 mt-3">
  <button pButton icon="pi pi-plus" label="Iniciar Contrato"
          (click)="openCreateContract()"
          class="p-button-warning p-button-lg"></button>
  <button *ngIf="project()?.status === 'PENDING_FUNDING'"
          pButton label="+ ANALIZAR RIESGO"
          class="p-button-warning p-button-lg"
          [routerLink]="['/analysis/risk', project()?.id]"
          [disabled]="!project()"></button>
</div>

<!-- ===== Panel Desplegable para Crear/Editar Contrato (solo inversor, se despliega con animación) ===== -->
<div *ngIf="accordionOpen()" @.disabled class="mt-3">
  <p-card [header]="editing ? 'Editar Contrato' : (reviewingToSign ? 'Revisar Contrato para Firmar' : 'Crear Nuevo Contrato')" styleClass="shadow-sm">
    <form [formGroup]="contractForm" class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3">
      <div class="md:col-span-2">
        <label class="text-sm font-medium flex items-center gap-2">
          <span>Título</span>
          <i class="pi pi-info-circle cursor-pointer" pTooltip="Dale un nombre único a tu oferta de contrato para identificarla fácilmente."></i>
        </label>
        <input pInputText formControlName="title" placeholder="Ej: Contrato de inversión" />
        <small class="text-red-500" *ngIf="contractForm.controls.title.invalid && contractForm.controls.title.touched">
          Título es requerido
        </small>
      </div>
      <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-5 gap-x-4 gap-y-3">
        <div class="md:col-span-2">
          <label class="text-sm font-medium flex items-center gap-2">
            <span>Monto</span>
            <i class="pi pi-info-circle cursor-pointer" pTooltip="La cantidad de dinero que ofreces invertir en el proyecto."></i>
          </label>
          <p-inputNumber formControlName="amount" [min]="0" [useGrouping]="true" [minFractionDigits]="0" [maxFractionDigits]="2"></p-inputNumber>
          <small class="text-red-500" *ngIf="contractForm.controls.amount.invalid && contractForm.controls.amount.touched">
            Monto inválido
          </small>
        </div>
        <div class="md:col-span-2">
          <label class="text-sm font-medium flex items-center gap-2">
            <span>Moneda</span>
            <i class="pi pi-info-circle cursor-pointer" pTooltip="La divisa en la que se realizará la inversión. El sistema la convertirá a USD para calcular el progreso de financiación."></i>
          </label>
          <select
            formControlName="currency"
            class="w-full p-3 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600">
            <option *ngFor="let c of currencyOptions" [value]="c.value">{{ c.label }} ({{c.value}})</option>
          </select>
        </div>
        <div class="md:col-span-1 flex flex-col justify-end">
          <label class="text-sm font-medium flex items-center gap-2">
            <span>Estado</span>
            <i class="pi pi-info-circle cursor-pointer" pTooltip="El estado actual del contrato. Comienza como 'Pendiente Firma' y cambia a 'Firmado' cuando el estudiante lo acepta."></i>
          </label>
          <p-tag [value]="currentContractStatusLabel()"
                 [ngStyle]="tagStyle(currentContractStatus())"></p-tag>
        </div>
      </div>

      <!-- Rentabilidad -->
      <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-3 mt-1">
        <div>
          <label class="text-sm font-medium flex items-center gap-2">
            <span>Rent. 1er año</span>
            <i class="pi pi-info-circle cursor-pointer" pTooltip="El porcentaje de ganancia que esperas recibir sobre tu inversión después del primer año."></i>
          </label>
          <div class="flex items-center gap-2 mt-2">
            <p-slider formControlName="profit1Year" [min]="0" [max]="100" class="flex-1" (onChange)="contractForm.controls.profit1Year.setValue($event.value)"></p-slider>
            <p-inputNumber formControlName="profit1Year" [min]="0" [max]="100" [showButtons]="false" suffix="%" inputStyleClass="w-10 text-right" class="w-16 -mr-2" (onInput)="contractForm.controls.profit1Year.setValue($event.value)"></p-inputNumber>
          </div>
          <small class="block text-right opacity-70 mt-1">
            Ganancia: {{ calculateProfit(contractForm.value.amount, contractForm.value.profit1Year) | currency:contractForm.value.currency:'symbol':'1.0-0' }}
          </small>
        </div>
        <div>
          <label class="text-sm font-medium flex items-center gap-2">
            <span>Rent. 2do año</span>
            <i class="pi pi-info-circle cursor-pointer" pTooltip="El porcentaje de ganancia que esperas recibir sobre tu inversión después del segundo año."></i>
          </label>
          <div class="flex items-center gap-2 mt-2">
            <p-slider formControlName="profit2Years" [min]="0" [max]="100" class="flex-1" (onChange)="contractForm.controls.profit2Years.setValue($event.value)"></p-slider>
            <p-inputNumber formControlName="profit2Years" [min]="0" [max]="100" [showButtons]="false" suffix="%" inputStyleClass="w-10 text-right" class="w-16 -mr-2" (onInput)="contractForm.controls.profit2Years.setValue($event.value)"></p-inputNumber>
          </div>
          <small class="block text-right opacity-70 mt-1">
            Ganancia: {{ calculateProfit(contractForm.value.amount, contractForm.value.profit2Years) | currency:contractForm.value.currency:'symbol':'1.0-0' }}
          </small>
        </div>
        <div>
          <label class="text-sm font-medium flex items-center gap-2">
            <span>Rent. 3er año</span>
            <i class="pi pi-info-circle cursor-pointer" pTooltip="El porcentaje de ganancia que esperas recibir sobre tu inversión después del tercer año."></i>
          </label>
          <div class="flex items-center gap-2 mt-2">
            <p-slider formControlName="profit3Years" [min]="0" [max]="100" class="flex-1" (onChange)="contractForm.controls.profit3Years.setValue($event.value)"></p-slider>
            <p-inputNumber formControlName="profit3Years" [min]="0" [max]="100" [showButtons]="false" suffix="%" inputStyleClass="w-10 text-right" class="w-16 -mr-2" (onInput)="contractForm.controls.profit3Years.setValue($event.value)"></p-inputNumber>
          </div>
          <small class="block text-right opacity-70 mt-1">
            Ganancia: {{ calculateProfit(contractForm.value.amount, contractForm.value.profit3Years) | currency:contractForm.value.currency:'symbol':'1.0-0' }}
          </small>
        </div>
      </div>
      <!-- Editor de Cláusulas -->
      <div class="md:col-span-2">
        <div class="flex justify-between items-center mb-1">
          <label class="text-sm font-medium flex items-center gap-2">
            <span>Cláusulas y Detalles del Contrato</span>
            <i class="pi pi-info-circle cursor-pointer" pTooltip="Aquí puedes detallar los términos, condiciones, obligaciones y cualquier otra cláusula relevante para el acuerdo."></i>
          </label>
          <button pButton type="button" icon="pi pi-book" label="Plantillas" (click)="menu.toggle($event)" class="p-button-text p-button-sm"></button>
          <p-menu #menu [model]="contractTemplates" [popup]="true"></p-menu>
        </div>
        <p-editor formControlName="clauses" [style]="{ height: '250px' }">
          <ng-template pTemplate="header">
            <span class="ql-formats">
              <button type="button" class="ql-bold" aria-label="Bold"></button>
              <button type="button" class="ql-italic" aria-label="Italic"></button>
              <button type="button" class="ql-underline" aria-label="Underline"></button>
              <button type="button" class="ql-list" value="ordered" aria-label="Ordered List"></button>
              <button type="button" class="ql-list" value="bullet" aria-label="Unordered List"></button>
              <button type="button" class="ql-link" aria-label="Link"></button>
            </span>
          </ng-template>
        </p-editor>
      </div>
    </form>
    <div class="mt-3 flex gap-2">
      <button pButton label="Cancelar" severity="secondary" [text]="true" (click)="cancelEdit()"></button>
      <!-- Botón para Guardar (Inversor creando/editando) -->
      <button *ngIf="!contractForm.disabled"
              pButton
              label="Guardar Contrato"
              icon="pi pi-check"
              severity="warning"
              (click)="saveContract()"
              [disabled]="contractForm.invalid"></button>
      <!-- Botones para Firmar o Rechazar (Estudiante revisando) -->
      <button *ngIf="reviewingToSign" pButton label="Firmar y Aceptar Contrato" icon="pi pi-file-edit" severity="warning" (click)="saveContract()"></button>
      <button *ngIf="reviewingToSign" pButton label="Rechazar Contrato" icon="pi pi-times-circle" severity="danger" (click)="rejectContract(reviewingToSign)"></button>
    </div>
  </p-card>
</div>

<!-- ===== Tabla de Contratos ===== -->
<p-card class="mt-3 shadow-sm">
  <ng-template pTemplate="header">
    <div class="flex justify-between items-center w-full">
      <h3 class="p-card-title">Contratos de este proyecto</h3>
    </div>
  </ng-template>
  <p-table [value]="contracts()" [paginator]="true" [rows]="6" [rowHover]="true" responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th style="width:80px">Número de contrato</th>
        <th>Título</th>
        <th>Monto</th>
        <th>Estado</th>
        <th>Fecha de Creación</th>
        <th *ngIf="isInvestor()" style="width:120px; text-align:center">Acciones (Inversor)</th>
        <th *ngIf="isOwner()" style="width:120px; text-align:center">Acciones (Dueño)</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-row>
      <tr>
         <td class="text-right">{{ row.idContract }}</td>
        <td>{{ row.textTitle }}</td>
        <td>{{ row.amount | currency:row.currency:'symbol':'1.0-0' }}</td>
        <td><p-tag [value]="getContractStatusLabel(row.status)" [ngStyle]="tagStyle(row.status)"></p-tag></td>
        <td>{{ row.createdAt | date:'dd/MM/yyyy' }}</td>
        <td class="text-center">
          <!-- ==================================================================== -->
          <!-- Botón de "Ver" (siempre visible para ambos roles) -->
          <button pButton [text]="true" [rounded]="true" [size]="'small'"
                  icon="pi pi-eye" pTooltip="Ver Detalles"
                  (click)="viewContract(row)"></button>

          <!-- ==================================================================== -->
          <!-- Acciones condicionales según el rol y el estado del contrato -->

          <!-- Acciones para el Inversor (si el contrato está pendiente) -->
          <ng-container *ngIf="isInvestor() && row.status === 'PENDING_STUDENT_SIGNATURE'">
            <button pButton [text]="true" [rounded]="true" [size]="'small'"
                    icon="pi pi-pencil" pTooltip="Editar Oferta" severity="warning"
                    (click)="editContract(row)">
            </button>
            <button pButton [text]="true" [rounded]="true" [size]="'small'"
                    icon="pi pi-times-circle" pTooltip="Retirar Oferta" severity="danger"
                    (click)="cancelContractByInvestor(row)">
            </button>
          </ng-container>

          <!-- Acciones para el Dueño del Proyecto (si el contrato está pendiente) -->
          <ng-container *ngIf="isOwner() && row.status === 'PENDING_STUDENT_SIGNATURE'">
            <button pButton [text]="true" [rounded]="true" [size]="'small'"
                    icon="pi pi-file-edit" pTooltip="Firmar Contrato" severity="success"
                    (click)="reviewAndSignContract(row)">
            </button>
          </ng-container>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td [attr.colspan]="isInvestor() || isOwner() ? 6 : 5">No hay contratos para este proyecto.</td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<!-- DIÁLOGO DE CONTACTO -->
<p-dialog header="Contactar al Líder del Proyecto" [(visible)]="contactDialogVisible" [modal]="true" [style]="{ width: '50vw', 'min-width': '350px' }">
  <form [formGroup]="contactForm" (ngSubmit)="sendContactEmail()">
    <div class="flex flex-col gap-4 pt-2">
      <div>
        <label for="subject" class="font-medium">Asunto</label>
        <input pInputText id="subject" formControlName="subject" class="w-full mt-1" />
        <small class="p-error" *ngIf="contactForm.controls.subject.invalid && contactForm.controls.subject.touched">
          El asunto es requerido.
        </small>
      </div>
      <div>
        <label for="message" class="font-medium">Mensaje</label>
        <textarea pInputTextarea id="message" formControlName="message" rows="6" class="w-full mt-1"></textarea>
        <small class="p-error" *ngIf="contactForm.controls.message.invalid && contactForm.controls.message.touched">
          El mensaje es requerido.
        </small>
      </div>
    </div>
  </form>
  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" severity="secondary" (click)="contactDialogVisible.set(false)"></button>
    <button pButton label="Enviar Mensaje" icon="pi pi-send" (click)="sendContactEmail()" [disabled]="contactForm.invalid"></button>
  </ng-template>
</p-dialog>
