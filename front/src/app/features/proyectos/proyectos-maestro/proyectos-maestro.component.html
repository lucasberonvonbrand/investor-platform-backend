<p-toolbar class="mb-3">
  <div class="p-toolbar-group-left">
    <button pButton icon="pi pi-arrow-left" label="Volver" (click)="goBack()"></button>
  </div>

  <div class="p-toolbar-group-right flex items-center gap-2">
    <button pButton icon="pi pi-user" label="Contactar" (click)="contactStudent()" [disabled]="!project()"></button>
  </div>
</p-toolbar>

<p-card class="shadow-sm">
  <ng-container *ngIf="project(); else loadingTpl">
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
      <div>
        <div class="text-2xl font-semibold">{{ project()?.title ?? '—' }}</div>
        <div class="opacity-70 mt-1">{{ project()?.summary ?? '—' }}</div>
        <div class="mt-2 flex gap-2 flex-wrap">
          <p-tag [value]="project()?.category ?? '—'" [ngStyle]="tagStyle(project()?.category ?? '—', 0)"></p-tag>
          <p-tag [value]="project()?.status ?? '—'"   [ngStyle]="tagStyle(project()?.status ?? '—', 1)"></p-tag>
          <ng-container *ngIf="project()?.university as uni">
            <p-tag [value]="uni" [ngStyle]="tagStyle(uni, 2)"></p-tag>
          </ng-container>
        </div>
      </div>

      <div class="text-right opacity-70 text-sm">
        <div *ngIf="project()?.fundingGoal != null || project()?.fundingRaised != null">
          Meta: {{ project()?.fundingGoal ?? '—' }} · Recaudado: {{ project()?.fundingRaised ?? '—' }}
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
      <p-card>
        <div class="font-semibold mb-2">Equipo</div>
        <ul class="list-disc ml-4">
          <li *ngFor="let s of team">
            {{ s.name }} <span class="opacity-60" *ngIf="s.email">— {{ s.email }}</span>
          </li>
          <li *ngIf="team.length === 0">—</li>
        </ul>
      </p-card>

      <p-card>
        <div class="font-semibold mb-2">Tags</div>
        <div class="flex gap-2 flex-wrap">
          <p-tag *ngFor="let t of (project()?.tags || []); let i = index" [value]="t" [ngStyle]="tagStyle(t, i)"></p-tag>
          <span *ngIf="!(project()?.tags?.length)">—</span>
        </div>
      </p-card>
    </div>
  </ng-container>

  <ng-template #loadingTpl>
    <div class="flex items-center gap-2"><i class="pi pi-spin pi-spinner"></i> Cargando proyecto...</div>
  </ng-template>
</p-card>

<!-- Botón "Iniciar Contrato" central y prominente (solo inversor, si el formulario no está abierto) -->
<div *ngIf="isInvestor() && !accordionOpen()" class="flex justify-center mt-3">
  <button pButton icon="pi pi-plus" label="Iniciar Contrato"
          (click)="openCreateContract()"
          class="p-button-warning p-button-lg"></button>
</div>

<!-- ===== Panel Desplegable para Crear/Editar Contrato (solo inversor, se despliega con animación) ===== -->
<div *ngIf="accordionOpen()" @.disabled class="mt-3">
  <p-card [header]="editing ? 'Editar Contrato' : 'Crear Nuevo Contrato'" styleClass="shadow-sm">
    <form [formGroup]="contractForm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="md:col-span-2">
        <label class="text-sm font-medium">Título</label>
        <input pInputText formControlName="title" placeholder="Ej: Contrato de inversión" />
        <small class="text-red-500" *ngIf="contractForm.controls.title.invalid && contractForm.controls.title.touched">
          Título es requerido
        </small>
      </div>
      <div class="md:col-span-2">
        <label class="text-sm font-medium">Monto</label>
        <p-inputNumber formControlName="amount" [min]="0" [useGrouping]="true" prefix="U$S "></p-inputNumber>
        <small class="text-red-500" *ngIf="contractForm.controls.amount.invalid && contractForm.controls.amount.touched">
          Monto inválido
        </small>
      </div>

      <!-- Rentabilidad -->
      <div class="md:col-span-2 grid grid-cols-3 gap-3">
        <div>
          <label class="text-sm font-medium">Rentabilidad 1er año (%)</label>
          <p-inputNumber formControlName="profit1Year" [min]="0" [max]="100" suffix="%"></p-inputNumber>
        </div>
        <div>
          <label class="text-sm font-medium">Rentabilidad 2do año (%)</label>
          <p-inputNumber formControlName="profit2Years" [min]="0" [max]="100" suffix="%"></p-inputNumber>
        </div>
        <div>
          <label class="text-sm font-medium">Rentabilidad 3er año (%)</label>
          <p-inputNumber formControlName="profit3Years" [min]="0" [max]="100" suffix="%"></p-inputNumber>
        </div>
      </div>
      <div>
        <label class="text-sm font-medium">Inicio</label>
        <p-datepicker formControlName="startDate" inputId="startDate"></p-datepicker>
      </div>
      <div>
        <label class="text-sm font-medium">Fin</label>
        <p-datepicker formControlName="endDate" inputId="endDate"></p-datepicker>
      </div>
      <!-- Editor de Cláusulas -->
      <div class="md:col-span-2">
        <label class="text-sm font-medium">Cláusulas y Detalles del Contrato</label>
        <p-editor formControlName="clauses" [style]="{ height: '250px' }"></p-editor>
      </div>
    </form>
    <div class="mt-3 flex gap-2">
      <button pButton label="Cancelar" severity="secondary" [text]="true" (click)="cancelEdit()"></button>
      <button pButton label="Guardar Contrato" icon="pi pi-check" severity="warning" (click)="saveContract()" [disabled]="contractForm.invalid"></button>
    </div>
  </p-card>
</div>

<!-- ===== Tabla de Contratos ===== -->
<p-card class="mt-3 shadow-sm">
  <ng-template pTemplate="header">
    <div class="flex justify-between items-center w-full">
      <h3 class="p-card-title">Contratos de este proyecto</h3>      
    </div>
  </ng-template>
  <p-table [value]="contracts()" [paginator]="true" [rows]="6" [rowHover]="true" responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th style="width:80px">Número de contrato</th>
        <th>Título</th>
        <th>Monto</th>
        <th>Estado</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th *ngIf="isInvestor()" style="width:120px; text-align:center">Acciones (Inversor)</th>
        <th *ngIf="isOwner()" style="width:120px; text-align:center">Acciones (Dueño)</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-row>
      <tr>
        <td class="text-right">{{ row.id }}</td>
        <td>{{ row.title }}</td>
        <td>{{ row.amount | number:'1.0-0' }}</td>
        <td><p-tag [value]="row.status" [ngStyle]="tagStyle(row.status)"></p-tag></td>
        <td>{{ row.startDate || '—' }}</td>
        <td>{{ row.endDate || '—' }}</td>
        <!-- Acciones para el Inversor -->
        <td *ngIf="isInvestor()" class="text-center">
          <button *ngIf="row.status === 'PENDING_STUDENT_SIGNATURE'"
                  pButton [text]="true" [rounded]="true" [size]="'small'"
                  icon="pi pi-pencil" pTooltip="Editar Oferta" severity="warning"
                  (click)="editContract(row)">
          </button>
          <button *ngIf="row.status === 'PENDING_STUDENT_SIGNATURE'"
                  pButton [text]="true" [rounded]="true" [size]="'small'"
                  icon="pi pi-times-circle" pTooltip="Retirar Oferta" severity="danger"
                  (click)="cancelContractByInvestor(row)">
          </button>
        </td>
        <!-- Acciones para el Dueño del Proyecto -->
        <td *ngIf="isOwner()" class="text-center">
          <button *ngIf="row.status === 'PENDING_STUDENT_SIGNATURE'"
                  pButton [text]="true" [rounded]="true" [size]="'small'"
                  icon="pi pi-file-edit" pTooltip="Firmar Contrato" severity="success"
                  (click)="signContract(row)">
          </button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td [attr.colspan]="isInvestor() ? 7 : (isOwner() ? 7 : 6)">No hay contratos para este proyecto.</td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
