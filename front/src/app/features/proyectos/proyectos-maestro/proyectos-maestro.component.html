<p-toolbar class="mb-3">
  <div class="p-toolbar-group-left">
    <button pButton icon="pi pi-arrow-left" label="Volver" (click)="goBack()"></button>
  </div>

  <div class="p-toolbar-group-right flex items-center gap-2">
    <button pButton icon="pi pi-user" label="Contactar" (click)="openContactDialog()" [disabled]="!project()"></button>
  </div>
</p-toolbar>

<p-card class="shadow-sm">
  <ng-container *ngIf="project(); else loadingTpl">
    <!-- Título y Resumen -->
    <div class="mb-4">
      <h2 class="text-2xl font-semibold">{{ project()?.title ?? '—' }}</h2>
      <p class="opacity-70 mt-1">{{ project()?.summary ?? '—' }}</p>
    </div>

    <!-- Metadatos del Proyecto -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
      <div>
        <div class="font-semibold text-gray-500 dark:text-gray-400">Líder del Proyecto</div>
        <div class="text-gray-800 dark:text-gray-100">{{ project()?.owner ?? 'No asignado' }}</div>
      </div>
      <div>
        <div class="font-semibold text-gray-500 dark:text-gray-400">Categoría</div>
        <div><p-tag [value]="project()?.category ?? '—'" [ngStyle]="tagStyle(project()?.category ?? '—', 0)"></p-tag></div>
      </div>
      <div>
        <div class="font-semibold text-gray-500 dark:text-gray-400 flex items-center gap-2">
          <span>Estado</span>
          <i class="pi pi-info-circle text-sm cursor-pointer"
             pTooltip="El estado del proyecto avanza automáticamente. Cambiará a 'En Progreso' cuando se confirme la primera inversión, y a 'Completado' al alcanzar la meta de financiación."
             tooltipPosition="top"></i>
        </div>
        <div><p-tag [value]="getProjectStatusLabel(project()?.status)" [ngStyle]="tagStyle(project()?.status ?? '—', 1)"></p-tag></div>
      </div>
      <div *ngIf="project()?.university as uni">
        <div class="font-semibold text-gray-500 dark:text-gray-400">Universidad</div>
        <div><p-tag [value]="uni" [ngStyle]="tagStyle(uni, 2)"></p-tag></div>
      </div>
      <div *ngIf="project()?.startDate as date">
        <div class="font-semibold text-gray-500 dark:text-gray-400">Fecha de Inicio</div>
        <div class="text-gray-800 dark:text-gray-100">{{ date | date:'dd/MM/yyyy' }}</div>
      </div>
      <div *ngIf="project()?.estimatedEndDate as date">
        <div class="font-semibold text-gray-500 dark:text-gray-400">Fecha Fin Estimada</div>
        <div class="text-gray-800 dark:text-gray-100">{{ date | date:'dd/MM/yyyy' }}</div>
      </div>
      <div class="md:col-span-2" *ngIf="project()?.fundingGoal != null || project()?.fundingRaised != null">
        <div class="font-semibold text-gray-500 dark:text-gray-400">Financiación</div>
        <div class="flex items-baseline gap-2">
          <span class="text-lg font-bold text-primary-500">{{ project()?.fundingRaised | currency:'USD':'symbol':'1.0-0' }}</span>
          <span class="text-gray-500">de {{ project()?.fundingGoal | currency:'USD':'symbol':'1.0-0' }}</span>
        </div>
        <p-progressBar [value]="fundingProgress()" [showValue]="false" styleClass="mt-2 h-2"
                       [ngClass]="{
                         'progress-low': fundingProgress() < 33,
                         'progress-medium': fundingProgress() >= 33 && fundingProgress() < 70,
                         'progress-high': fundingProgress() >= 70
                       }">
        </p-progressBar>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4 border-t pt-4">
      <p-card>
        <div class="font-semibold mb-2">Equipo</div>
        <ul class="list-disc ml-4">
          <li *ngFor="let s of team">
            {{ s.name }} <span class="opacity-60" *ngIf="s.email">— {{ s.email }}</span>
          </li>
          <li *ngIf="team.length === 0">—</li>
        </ul>
      </p-card>

      <p-card>
        <div class="font-semibold mb-2">Documentación del Proyecto</div>
        <div class="text-center opacity-60 p-4 border-2 border-dashed rounded-lg">
          <i class="pi pi-inbox text-2xl mb-2"></i>
          <div>Próximamente: aquí se mostrarán los documentos adjuntos.</div>
        </div>
      </p-card>
    </div>
  </ng-container>

  <ng-template #loadingTpl>
    <div class="flex items-center gap-2"><i class="pi pi-spin pi-spinner"></i> Cargando proyecto...</div>
  </ng-template>
</p-card>

<!-- Botón "Iniciar Contrato" central y prominente (solo inversor, si el formulario no está abierto) -->
<div *ngIf="isInvestor() && !contractModalVisible()" class="text-center mt-3">
  <div *ngIf="project()?.status === 'PENDING_FUNDING'; else projectFunded">
    <div class="flex justify-center items-center gap-3">
      <button pButton icon="pi pi-plus" label="Iniciar Contrato"
              (click)="openCreateContract()"
              class="p-button-warning p-button-lg"></button>
      <button pButton label="+ ANALIZAR RIESGO"
              class="p-button-warning p-button-lg"
              [routerLink]="['/analysis/risk', project()?.id]"
              [disabled]="!project()"></button>
    </div>
  </div>
  <ng-template #projectFunded>
    <div class="inline-flex items-center gap-2 p-3 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 rounded-lg">
      <i class="pi pi-check-circle"></i>
      <span class="font-semibold">Este proyecto ya ha sido financiado y no acepta nuevos contratos.</span>
    </div>
  </ng-template>
</div>

<!-- ===== Tabla de Contratos ===== -->
<p-card class="mt-3 shadow-sm">
  <ng-template pTemplate="header">
    <div class="flex justify-between items-center w-full">
      <h3 class="p-card-title">Contratos de este proyecto</h3>
    </div>
  </ng-template>
  <p-table [value]="contracts()" [paginator]="true" [rows]="6" [rowHover]="true" responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th style="width:80px">Número de contrato</th>
        <th>Título</th>
        <th>Monto</th>
        <th>Estado</th>
        <th>Fecha de Creación</th>
        <th style="width:200px; text-align:center">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-row>
      <tr>
        <!-- Datos de la fila del contrato -->
         <td class="text-right">{{ row.idContract }}</td>
        <td>{{ row.textTitle }}</td>
        <td>{{ row.amount | currency:row.currency:'symbol':'1.0-0' }}</td>
        <td><p-tag [value]="getContractStatusLabel(row.status)" [ngStyle]="tagStyle(row.status)"></p-tag></td>
        <td>{{ row.createdAt | date:'dd/MM/yyyy' }}</td>
        <td class="text-center">
          <!-- ==================================================================== -->
          <!-- Acciones condicionales según el rol y el estado del contrato -->
          <button pButton [text]="true" [rounded]="true" [size]="'small'" icon="pi pi-eye" pTooltip="Ver Detalles" (click)="viewContract(row)"></button>

          <!-- Acciones para el Inversor -->
          <ng-container *ngIf="isInvestor()">
            <button pButton [text]="true" [rounded]="true" [size]="'small'"
                    *ngIf="row.status === 'DRAFT'"
                    icon="pi pi-pencil" pTooltip="Editar Borrador" severity="warning"
                    (click)="editContract(row)">
            </button>
            <button pButton [text]="true" [rounded]="true" [size]="'small'"
                    *ngIf="row.status === 'PENDING_STUDENT_SIGNATURE'"
                    icon="pi pi-times-circle" pTooltip="Retirar Oferta" severity="danger"
                    (click)="cancelContractByInvestor(row)">
            </button>
            <button pButton [text]="true" [rounded]="true" [size]="'small'"
                    *ngIf="row.status === 'PARTIALLY_SIGNED'"
                    icon="pi pi-file-edit" pTooltip="Firmar Contrato" severity="success"
                    (click)="signContract(row)">
            </button>
          </ng-container>

          <!-- Acciones para el Dueño del Proyecto -->
          <ng-container *ngIf="isOwner()">
            <button pButton [text]="true" [rounded]="true" [size]="'small'"
                    *ngIf="row.status === 'DRAFT'"
                    icon="pi pi-pencil" pTooltip="Editar Borrador" severity="warning"
                    (click)="editContract(row)">
            </button>
            <button pButton [text]="true" [rounded]="true" [size]="'small'"
                    *ngIf="row.status === 'PARTIALLY_SIGNED'"
                    icon="pi pi-file-edit" pTooltip="Firmar Contrato" severity="success"
                    (click)="reviewAndSignContract(row)">
            </button>
          </ng-container>

          <!-- Acciones para Contratos Firmados -->
          <ng-container *ngIf="row.status === 'SIGNED'">
            <!-- Botón para gestionar la inversión inicial -->
            <button pButton type="button" label="Gestionar Inversión" icon="pi pi-dollar"
                    class="p-button-secondary p-button-outlined p-button-sm ml-2"
                    (click)="openTransactionModal(row)"></button>
            <!-- Botón para que el estudiante cierre el contrato y genere la ganancia -->
            <button *ngIf="isOwner() && row.investment?.status === 'RECEIVED'" pButton type="button" label="Cerrar Contrato" icon="pi pi-check-circle"
                    class="p-button-success p-button-outlined p-button-sm ml-2"
                    (click)="closeContract(row)"></button>
          </ng-container>
          <!-- Botón para gestionar las ganancias (cuando el contrato está cerrado) -->
          <button *ngIf="row.status === 'CLOSED'" pButton type="button" label="Gestionar Ganancias" icon="pi pi-chart-line"
                  class="p-button-help p-button-outlined p-button-sm ml-2"
                  (click)="openEarningModal(row)"></button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center font-semibold p-4">
          <!-- Mensaje específico para el inversor -->
          <div *ngIf="isInvestor(); else genericEmptyMsg">
            USTED NO TIENE CONTRATOS EN ESTE PROYECTO
          </div>
          <!-- Mensaje genérico para el estudiante/otros -->
          <ng-template #genericEmptyMsg>No hay contratos para este proyecto.</ng-template>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<!-- ===== DIÁLOGO PARA CREAR/EDITAR CONTRATO ===== -->
<p-dialog [header]="isReadonly() ? 'Detalles del Contrato' : (editing ? 'Editar Contrato' : 'Crear Nuevo Contrato')"
          [visible]="contractModalVisible()" (visibleChange)="contractModalVisible.set($event)" [modal]="true" 
          [style]="{ width: '90vw', 'max-width': '1200px' }" [draggable]="false" (onHide)="cancelEdit()">
  <form [formGroup]="contractForm" class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3 pt-4">
    <div class="md:col-span-2">
      <label class="text-sm font-medium flex items-center gap-2">
        <span>Título</span>
        <i class="pi pi-info-circle cursor-pointer" pTooltip="Dale un nombre único a tu oferta de contrato para identificarla fácilmente."></i>
      </label>
      <input pInputText formControlName="title" placeholder="Ej: Contrato de inversión" [readonly]="isReadonly()" />
      <small class="text-red-500" *ngIf="contractForm.controls.title.invalid && contractForm.controls.title.touched">
        Título es requerido
      </small>
    </div>
    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-5 gap-x-4 gap-y-3">
      <div class="md:col-span-2">
        <label class="text-sm font-medium flex items-center gap-2">
          <span>Monto</span>
          <i class="pi pi-info-circle cursor-pointer" pTooltip="La cantidad de dinero que ofreces invertir en el proyecto."></i>
        </label>
        <p-inputNumber formControlName="amount" [min]="0" [useGrouping]="true" [minFractionDigits]="0" [maxFractionDigits]="2" [readonly]="isReadonly()"></p-inputNumber>
        <small class="text-red-500" *ngIf="contractForm.controls.amount.invalid && contractForm.controls.amount.touched">
          Monto inválido
        </small>
      </div>
      <div class="md:col-span-2">
        <label class="text-sm font-medium flex items-center gap-2">
          <span>Moneda</span>
          <i class="pi pi-info-circle cursor-pointer" pTooltip="La divisa en la que se realizará la inversión. El sistema la convertirá a USD para calcular el progreso de financiación."></i>
        </label>
        <!-- MODO EDICIÓN: Mostrar el select nativo -->
        <select *ngIf="!isReadonly()" formControlName="currency" class="w-full p-3 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600">
          <option *ngFor="let c of currencyOptions" [value]="c.value">{{ c.label }} ({{c.value}})</option>
        </select>
        <!-- MODO SOLO LECTURA: Mostrar el valor como texto simple -->
        <div *ngIf="isReadonly()" class="w-full p-3 border border-gray-300 rounded-md bg-gray-100 dark:bg-gray-700/50 dark:border-gray-600">
          {{ contractForm.controls.currency.value }}
        </div>
      </div>
      <div class="md:col-span-1 flex flex-col justify-end">
        <label class="text-sm font-medium flex items-center gap-2">
          <span>Estado</span>
          <i class="pi pi-info-circle cursor-pointer" pTooltip="El estado actual del contrato. Comienza como 'Pendiente Firma' y cambia a 'Firmado' cuando el estudiante lo acepta."></i>
        </label>
        <p-tag [value]="currentContractStatusLabel()"
               [ngStyle]="tagStyle(currentContractStatus())"></p-tag>
      </div>
    </div>

    <!-- Rentabilidad -->
    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-3 mt-1">
      <div>
        <label class="text-sm font-medium flex items-center gap-2">
          <span>Rent. 1er año</span>
          <i class="pi pi-info-circle cursor-pointer" pTooltip="El porcentaje de ganancia que esperas recibir sobre tu inversión después del primer año."></i>
        </label>
        <div class="flex items-center gap-2 mt-2">
          <p-slider formControlName="profit1Year" [min]="0" [max]="100" class="flex-1" (onChange)="contractForm.controls.profit1Year.setValue($event.value)" [disabled]="isReadonly()"></p-slider>
          <p-inputNumber formControlName="profit1Year" [min]="0" [max]="100" [showButtons]="false" suffix="%" inputStyleClass="w-10 text-right" class="w-16 -mr-2" (onInput)="contractForm.controls.profit1Year.setValue($event.value)" [readonly]="isReadonly()"></p-inputNumber>
        </div>
        <small class="block text-right opacity-70 mt-1">
          Ganancia: {{ calculateProfit(contractForm.value.amount, contractForm.value.profit1Year) | currency:contractForm.value.currency:'symbol':'1.0-0' }}
        </small>
      </div>
      <div>
        <label class="text-sm font-medium flex items-center gap-2">
          <span>Rent. 2do año</span>
          <i class="pi pi-info-circle cursor-pointer" pTooltip="El porcentaje de ganancia que esperas recibir sobre tu inversión después del segundo año."></i>
        </label>
        <div class="flex items-center gap-2 mt-2">
          <p-slider formControlName="profit2Years" [min]="0" [max]="100" class="flex-1" (onChange)="contractForm.controls.profit2Years.setValue($event.value)" [disabled]="isReadonly()"></p-slider>
          <p-inputNumber formControlName="profit2Years" [min]="0" [max]="100" [showButtons]="false" suffix="%" inputStyleClass="w-10 text-right" class="w-16 -mr-2" (onInput)="contractForm.controls.profit2Years.setValue($event.value)" [readonly]="isReadonly()"></p-inputNumber>
        </div>
        <small class="block text-right opacity-70 mt-1">
          Ganancia: {{ calculateProfit(contractForm.value.amount, contractForm.value.profit2Years) | currency:contractForm.value.currency:'symbol':'1.0-0' }}
        </small>
      </div>
      <div>
        <label class="text-sm font-medium flex items-center gap-2">
          <span>Rent. 3er año</span>
          <i class="pi pi-info-circle cursor-pointer" pTooltip="El porcentaje de ganancia que esperas recibir sobre tu inversión después del tercer año."></i>
        </label>
        <div class="flex items-center gap-2 mt-2">
          <p-slider formControlName="profit3Years" [min]="0" [max]="100" class="flex-1" (onChange)="contractForm.controls.profit3Years.setValue($event.value)" [disabled]="isReadonly()"></p-slider>
          <p-inputNumber formControlName="profit3Years" [min]="0" [max]="100" [showButtons]="false" suffix="%" inputStyleClass="w-10 text-right" class="w-16 -mr-2" (onInput)="contractForm.controls.profit3Years.setValue($event.value)" [readonly]="isReadonly()"></p-inputNumber>
        </div>
        <small class="block text-right opacity-70 mt-1">
          Ganancia: {{ calculateProfit(contractForm.value.amount, contractForm.value.profit3Years) | currency:contractForm.value.currency:'symbol':'1.0-0' }}
        </small>
      </div>
    </div>
    <!-- Editor de Cláusulas -->
    <div class="md:col-span-2">
      <div class="flex justify-between items-center mb-1">
        <label class="text-sm font-medium flex items-center gap-2">
          <span>Cláusulas y Detalles del Contrato</span>
          <i class="pi pi-info-circle cursor-pointer" pTooltip="Aquí puedes detallar los términos, condiciones, obligaciones y cualquier otra cláusula relevante para el acuerdo."></i>
        </label>
        <button *ngIf="!isReadonly()" pButton type="button" icon="pi pi-book" label="Plantillas" (click)="menu.toggle($event)" class="p-button-text p-button-sm"></button>
        <p-menu #menu [model]="contractTemplates" [popup]="true"></p-menu>
      </div>
      <!-- Ciclo de Vida del Contrato -->
      <div class="md:col-span-2 mt-4" *ngIf="viewingOnly() || reviewingToSign || editing">
        <h4 class="font-semibold text-lg mb-2">Ciclo de Vida del Contrato</h4>
        <p-steps [model]="contractLifecycleSteps()" [readonly]="true" [activeIndex]="contractLifecycleActiveIndex()" styleClass="contract-steps"></p-steps>
      </div>

      <!-- MODO EDICIÓN: Mostrar el editor -->
      <p-editor *ngIf="!isReadonly() && showEditor()" formControlName="description" [style]="{ height: '250px' }">
          <ng-template pTemplate="header">
              <span class="ql-formats">
                  <button type="button" class="ql-bold" aria-label="Bold"></button>
                  <button type="button" class="ql-italic" aria-label="Italic"></button>
                  <button type="button" class="ql-underline" aria-label="Underline"></button>
              </span>
          </ng-template>
      </p-editor>
      <!-- MODO SOLO LECTURA: Mostrar el contenido en un div -->
      <div #contractContent *ngIf="isReadonly()" class="p-4 border rounded-md bg-gray-50 dark:bg-gray-800" style="height: 250px; overflow-y: auto;">
          <div [innerHTML]="contractForm.controls.description.value | safeHtml"></div>
      </div>
    </div>
  </form>
  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" severity="secondary" [text]="true" (click)="cancelEdit()"></button>
    <!-- Botón para Descargar PDF (cuando es solo lectura) -->
    <button *ngIf="isReadonly()" pButton label="Descargar en PDF" icon="pi pi-download" severity="info" (click)="downloadContractAsPDF()"></button>

    <!-- Botón para Guardar (cuando NO es solo lectura) -->
    <button *ngIf="!isReadonly()" pButton label="Guardar Contrato" icon="pi pi-check" severity="warning" (click)="saveContract()" [disabled]="contractForm.invalid"></button>
    <!-- Botones para Firmar o Rechazar (Estudiante revisando) -->
    <button *ngIf="reviewingToSign" pButton label="Firmar y Aceptar Contrato" icon="pi pi-file-edit" severity="warning" (click)="saveContract()"></button>
    <!-- Botón para Aprobar y Bloquear (cuando se edita un DRAFT) -->
    <button *ngIf="editing && editing.status === 'DRAFT'" pButton
            label="Aprobar y Bloquear Contrato" icon="pi pi-check-circle" severity="success"
            (click)="agreeToContractTerms(editing)">
    </button>
    <button *ngIf="reviewingToSign" pButton label="Rechazar Contrato" icon="pi pi-times-circle" severity="danger" (click)="rejectContract(reviewingToSign)"></button>
  </ng-template>
</p-dialog>

<!-- ===== DIÁLOGO PARA GESTIÓN DE TRANSACCIONES ===== -->
<p-dialog header="Gestión de Pagos del Contrato" [visible]="transactionModalVisible()"
          (visibleChange)="transactionModalVisible.set($event)" [modal]="true"
          [style]="{ width: '90vw', 'max-width': '1200px' }" [draggable]="false"
          (onHide)="selectedContractForTransactions.set(null)">
  <ng-container *ngIf="selectedContractForTransactions() as contract">
    <!-- Encabezado con información clave -->
    <div class="mb-4 p-3 border rounded-lg bg-gray-100 dark:bg-gray-900 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i class="pi pi-file-text text-2xl text-primary-500"></i>
        <div>
          <div class="font-semibold">{{ contract.textTitle }}</div>
          <div class="text-sm opacity-70">Contrato #{{ contract.idContract }}</div>
        </div>
      </div>
      <div class="text-right">
        <div class="text-sm opacity-70">Monto Acordado</div>
        <div class="font-bold text-xl">{{ contract.amount | currency:contract.currency:'symbol':'1.0-0' }}</div>
      </div>
    </div>

    <!-- Ciclo de Vida de la Inversión -->
    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border mt-3">
      <h3 class="font-semibold text-lg mb-3">Ciclo de Vida de la Inversión</h3>
      <div *ngIf="contract.investment; else noInvestmentInfo">
        <p-steps [model]="investmentLifecycleSteps()" [readonly]="true" [activeIndex]="investmentLifecycleActiveIndex()" styleClass="contract-steps"></p-steps>
      </div>
      <ng-template #noInvestmentInfo>
        <div class="text-center opacity-60 p-4">No hay información de inversión disponible para este contrato.</div>
      </ng-template>
    </div>
    <!-- Contenido principal del modal -->
    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border">
      <h3 class="font-semibold text-lg mb-3">Gestión de la Inversión</h3>

      <!-- Panel de estado y acciones -->
      <div *ngIf="contract.investment as investment" class="flex flex-col md:flex-row items-center justify-between gap-4 p-4 rounded-lg"
             [ngClass]="{
               'bg-blue-100 dark:bg-blue-900/30': investment.status === 'IN_PROGRESS',
               'bg-yellow-100 dark:bg-yellow-900/30': investment.status === 'PENDING_CONFIRMATION',
               'bg-green-100 dark:bg-green-900/30': investment.status === 'RECEIVED' || investment.status === 'COMPLETED',
               'bg-red-100 dark:bg-red-900/30': investment.status === 'NOT_RECEIVED' || investment.status === 'CANCELLED'
             }">
          <!-- Columna Izquierda: Información del Estado -->
          <div class="flex items-center gap-3">
            <i class="pi pi-info-circle text-xl"></i>
            <div>
              <div class="font-bold text-lg">{{ getInvestmentStatusLabel(investment.status) }}</div>
              <div class="text-sm opacity-80" *ngIf="investment.status === 'IN_PROGRESS'">El inversor debe notificar el envío de los fondos.</div>
              <div class="text-sm opacity-80" *ngIf="investment.status === 'PENDING_CONFIRMATION'">Esperando que el dueño del proyecto confirme la recepción de los fondos.</div>
              <div class="text-sm opacity-80" *ngIf="investment.status === 'RECEIVED' || investment.status === 'COMPLETED'">¡Inversión completada con éxito!</div>
              <div class="text-sm opacity-80" *ngIf="investment.status === 'NOT_RECEIVED' || investment.status === 'CANCELLED'">La transacción fue cancelada.</div>
            </div>
          </div>
          <!-- Columna Derecha: Botones de Acción -->
          <div>
            <!-- Acción para el Inversor -->
            <button *ngIf="isInvestor() && investment.status === 'IN_PROGRESS'" pButton label="Notificar Envío de Fondos" icon="pi pi-send" (click)="confirmInvestmentPaymentSent(investment.idInvestment)" [loading]="isProcessingTransaction()" [disabled]="isProcessingTransaction()"></button>
            <!-- Acciones para el Dueño del Proyecto -->
            <div *ngIf="isOwner() && investment.status === 'PENDING_CONFIRMATION'" class="flex gap-2">
              <button pButton label="Confirmar Recepción" icon="pi pi-check-circle" severity="success" (click)="confirmInvestmentReceipt(investment.idInvestment)" [loading]="isProcessingTransaction()" [disabled]="isProcessingTransaction()"></button>
              <button pButton label="Marcar como No Recibido" icon="pi pi-times-circle" severity="danger" (click)="markInvestmentAsNotReceived(investment.idInvestment)" [loading]="isProcessingTransaction()" [disabled]="isProcessingTransaction()"></button>
            </div>
          </div>
        </div>
      <div *ngIf="!contract.investment" class="text-center opacity-60 p-4">
        No hay información de inversión disponible para este contrato.
      </div>
    </div>
  </ng-container>
</p-dialog>

<!-- ===== DIÁLOGO PARA GESTIÓN DE GANANCIAS (EARNINGS) ===== -->
<p-dialog header="Gestión de Pago de Ganancias" [visible]="earningModalVisible()"
          (visibleChange)="earningModalVisible.set($event)" [modal]="true"
          [style]="{ width: '90vw', 'max-width': '1200px' }" [draggable]="false"
          (onHide)="selectedContractForEarnings.set(null)">
  <ng-container *ngIf="selectedContractForEarnings() as contract">
    <!-- Encabezado con información clave -->
    <div class="mb-4 p-3 border rounded-lg bg-gray-100 dark:bg-gray-900 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i class="pi pi-chart-line text-2xl text-purple-500"></i>
        <div>
          <div class="font-semibold">{{ contract.textTitle }}</div>
          <div class="text-sm opacity-70">Contrato #{{ contract.idContract }}</div>
        </div>
      </div>
      <div class="text-right" *ngIf="contract.earnings && contract.earnings.length > 0">
        <div class="text-sm opacity-70">Monto Total a Devolver</div>
        <div class="font-bold text-xl">{{ contract.earnings[0].amount | currency:contract.earnings[0].currency:'symbol':'1.0-0' }}</div>
      </div>
    </div>

    <!-- Contenido principal del modal -->
    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border">
      <h3 class="font-semibold text-lg mb-3">Gestión de la Devolución de Ganancia</h3>
      <div class="mb-4 text-sm opacity-80">
        Aquí puedes ver el estado de cada pago de ganancia asociado a este contrato.
      </div>


      <!-- Panel de estado y acciones para la primera ganancia -->
      <ng-container *ngIf="!isProcessingEarning(); else loadingEarnings">
        <div *ngIf="contract.earnings && contract.earnings.length > 0; else noEarnings">
          <!-- Bucle para cada ganancia -->
          <div *ngFor="let earning of contract.earnings; let i = index" class="mb-4">
            <!-- Ciclo de Vida de la Ganancia para cada earning -->
            <div class="w-full">
              <h4 class="font-semibold text-md mb-2">Ganancia #{{ i + 1 }}</h4>
              <p-steps [model]="earningLifecycleSteps()" [readonly]="true" [activeIndex]="earningLifecycleActiveIndex(earning)" styleClass="contract-steps"></p-steps>
            </div>
            <!-- Contenedor para las acciones y el estado -->
            <div class="flex flex-col md:flex-row items-center justify-between gap-4 p-4 rounded-lg mt-2" [ngClass]="{
                'bg-yellow-100 dark:bg-yellow-900/30': earning.status === 'PENDING_CONFIRMATION',
                'bg-green-100 dark:bg-green-900/30': earning.status === 'RECEIVED',
                'bg-red-100 dark:bg-red-900/30': earning.status === 'NOT_RECEIVED'
              }">
              <!-- Columna Izquierda: Información del Estado -->
              <div class="flex items-center gap-3">
                <i class="pi pi-info-circle text-xl"></i>
                <div class="flex flex-col gap-1">
                  <!-- Etiqueta de estado con estilo mejorado -->
                  <p-tag [value]="getEarningStatusLabel(earning.status)"
                         [severity]="earning.status === 'NOT_RECEIVED' ? 'danger' : (earning.status === 'RECEIVED' ? 'success' : 'info')"
                         [rounded]="true"
                         [icon]="earning.status === 'NOT_RECEIVED' ? 'pi pi-exclamation-triangle' : (earning.status === 'RECEIVED' ? 'pi pi-check-circle' : '')">
                  </p-tag>
                  <div class="text-sm opacity-80" *ngIf="earning.status === 'IN_PROGRESS'">El estudiante debe notificar el envío de la ganancia.</div>
                  <div class="text-sm opacity-80" *ngIf="earning.status === 'PENDING_CONFIRMATION'">Esperando que el inversor confirme la recepción de la ganancia.</div>
                  <div class="text-sm opacity-80" *ngIf="earning.status === 'NOT_RECEIVED'">
                    El inversor marcó este pago como no recibido. Por favor, verifica y reintenta el envío.
                    <span class="font-bold text-yellow-700 dark:text-yellow-300"> (Intentos restantes: {{ earning.retryAttempts ?? 3 }})</span>
                  </div>
                  <div class="text-sm opacity-80" *ngIf="earning.status === 'RECEIVED'">¡Ganancia completada con éxito!</div>
                </div>
              </div>
              <!-- Columna Derecha: Botones de Acción -->
              <!-- Solo mostrar acciones si el estado NO es 'RECEIVED' -->
              <div *ngIf="earning.status !== 'RECEIVED'">
                <!-- Acción para el Estudiante -->
                <button *ngIf="isOwner() && earning.status === 'IN_PROGRESS'" pButton label="Notificar Envío de Ganancia" icon="pi pi-send" (click)="confirmEarningPaymentSent(earning.idEarning)" [loading]="isProcessingEarning()"></button>
                <!-- Acción para el Estudiante para Reintentar -->
                <button *ngIf="isOwner() && earning.status === 'NOT_RECEIVED'" pButton label="Reintentar Envío" icon="pi pi-replay" severity="warning" 
                        (click)="retryEarningPayment(earning.idEarning)" [loading]="isProcessingEarning()" [disabled]="(earning.retryAttempts ?? 3) <= 0"
                        [pTooltip]="(earning.retryAttempts ?? 3) > 0 ? 'Reinicia el proceso de pago para volver a notificar el envío' : 'No quedan intentos de reenvío. Contacta con el inversor o soporte.'"
                        tooltipPosition="top"></button>
                <!-- Acciones para el Inversor -->
                <div *ngIf="isInvestor() && earning.status === 'PENDING_CONFIRMATION'" class="flex gap-2">
                  <button pButton label="Confirmar Recepción" icon="pi pi-check-circle" severity="success" (click)="confirmEarningReceipt(earning.idEarning)" [loading]="isProcessingEarning()"></button>
                  <button pButton label="No Recibido" icon="pi pi-times-circle" severity="danger" (click)="markEarningAsNotReceived(earning.idEarning)" [loading]="isProcessingEarning()"></button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <ng-template #noEarnings>
          <div class="text-center opacity-60 p-4">No hay información de ganancias disponible para este contrato.</div>
        </ng-template>
      </ng-container>
      <ng-template #loadingEarnings>
        <div class="flex items-center justify-center p-4 gap-2 opacity-60">
          <i class="pi pi-spin pi-spinner"></i>
          <span>Cargando detalles de la ganancia...</span>
        </div>
      </ng-template>
    </div>
  </ng-container>
</p-dialog>

<!-- DIÁLOGO DE CONTACTO -->
<p-dialog header="Contactar al Líder del Proyecto" [(visible)]="contactDialogVisible" [modal]="true" [style]="{ width: '50vw', 'min-width': '350px' }">
  <form [formGroup]="contactForm" (ngSubmit)="sendContactEmail()">
    <div class="flex flex-col gap-4 pt-2">
      <div>
        <label for="subject" class="font-medium">Asunto</label>
        <input pInputText id="subject" formControlName="subject" class="w-full mt-1" />
        <small class="p-error" *ngIf="contactForm.controls.subject.invalid && contactForm.controls.subject.touched">
          El asunto es requerido.
        </small>
      </div>
      <div>
        <label for="message" class="font-medium">Mensaje</label>
        <textarea pInputTextarea id="message" formControlName="message" rows="6" class="w-full mt-1"></textarea>
        <small class="p-error" *ngIf="contactForm.controls.message.invalid && contactForm.controls.message.touched">
          El mensaje es requerido.
        </small>
      </div>
    </div>
  </form>
  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" severity="secondary" (click)="contactDialogVisible.set(false)"></button>
    <button pButton label="Enviar Mensaje" icon="pi pi-send" (click)="sendContactEmail()" [disabled]="contactForm.invalid"></button>
  </ng-template>
</p-dialog>
