<p-toast></p-toast>

<p-toolbar class="mb-3">
  <div class="p-toolbar-group-left flex items-center gap-2">
    <button pButton icon="pi pi-arrow-left" (click)="goBack()" [text]="true" [rounded]="true" [size]="'small'"></button>
    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input pInputText type="text" placeholder="Buscar proyectos..."
            [(ngModel)]="q" (input)="applyFilters()" />
    </span>

    <span class="ml-2">
      <select class="p-inputtext p-component" [(ngModel)]="selectedCategory" (change)="applyFilters()">
        <option [ngValue]="''">Todas las categorías</option>
      <option *ngFor="let c of categories" [ngValue]="c">{{ c }}</option>
      </select>
    </span>
  </div>

  <div class="p-toolbar-group-right flex items-center gap-2">
    <button pButton icon="pi pi-th-large" label="Cards"
            [outlined]="viewMode!=='cards'"
            (click)="viewMode='cards'"></button>
    <button pButton icon="pi pi-table" label="Tabla"
            [outlined]="viewMode!=='table'"
            (click)="viewMode='table'"></button>
    <button pButton label="Refrescar" icon="pi pi-refresh" (click)="reload()" [disabled]="loading"></button>
  </div>
</p-toolbar>

<!-- KPIs -->

<div class="grid grid-cols-1 md:grid-cols-4 gap-3">

  <p-card class="shadow-sm">
    <div class="flex items-center gap-3">
      <span class="pi pi-briefcase text-2xl opacity-80"></span>
      <div><div class="text-xs opacity-70">Proyectos totales</div><div class="text-xl font-bold">{{ projects.length }}</div></div>
    </div>
  </p-card>

  <p-card class="shadow-sm">
    <div class="flex items-center gap-3">
      <span class="pi pi-tag text-2xl opacity-80"></span>
      <div><div class="text-xs opacity-70">Etiqueta</div><div class="text-xl font-bold">{{ displayTag }}</div></div>
    </div>
  </p-card>

  <p-card class="shadow-sm">
    <div class="flex items-center gap-3">
      <span class="pi pi-filter text-2xl opacity-80"></span>
      <div><div class="text-xs opacity-70">Resultados filtrados</div><div class="text-xl font-bold">{{ filtered.length }}</div></div>
    </div>
  </p-card>
  <p-card class="shadow-sm">
    <div class="flex items-center gap-3">
      <span class="pi pi-clock text-2xl opacity-80"></span>
      <div><div class="text-xs opacity-70">Recientes (30d)</div><div class="text-xl font-bold">N/A</div></div>
    </div>
  </p-card>
</div>



<!-- Cards -->

<p-card class="mt-4 shadow-sm" [header]="'Proyectos · ' + displayTag">
    <div *ngIf="viewMode==='cards'">
    <div *ngIf="!loading" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
      <div *ngFor="let p of filtered"
           class="border rounded-xl p-3 h-full flex flex-col">
        <div class="flex items-start justify-between gap-3">
          <div class="font-semibold text-lg leading-tight">{{ p.title }}</div>
                    <button pButton [text]="true" [rounded]="true" [size]="'small'"
                  [icon]="'pi pi-bookmark'"
                  pTooltip="Guardar"
                  [disabled]="true"></button>
        </div>

        <div class="opacity-70 text-sm mt-1 line-clamp-3">{{ p.summary || '—' }}</div>
        <div class="mt-2 flex gap-2 flex-wrap">
          <p-tag [value]="p.category || '—'" [ngStyle]="tagStyle(p.category || '—', 0)"></p-tag>
          <p-tag [value]="p.status || '—'"   [ngStyle]="tagStyle(p.status || '—', 1)"></p-tag>
          <p-tag *ngIf="p.university" [value]="p.university" [ngStyle]="tagStyle(p.university, 2)"></p-tag>
          <p-tag *ngFor="let t of (p.tags || []); let i = index" [value]="t" [ngStyle]="tagStyle(t, i+3)"></p-tag>
        </div>
        <div class="mt-3 flex-1"></div>
        <div class="mt-3 flex items-center justify-between">
          <button pButton type="button" label="Ver" icon="pi pi-eye" (click)="openDetail(p)"></button>
          <span class="text-xs opacity-70">Tags: {{ displayTag }}</span>
        </div>
      </div>
    </div>
    <div *ngIf="loading" class="loading-placeholder">Cargando proyectos...</div>
    <div *ngIf="!loading && filtered.length===0" class="empty">No se encontraron proyectos para esta etiqueta.</div>
  </div>
</p-card>



<!-- Tabla -->

<p-card class="mt-4 shadow-sm" *ngIf="viewMode==='table'" [header]="'Proyectos · ' + displayTag">
    <p-table [value]="filtered" [loading]="loading" dataKey="id"
          [rowHover]="true" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,25,50]"
          responsiveLayout="scroll">
    <ng-template pTemplate="header">

      <tr>
        <th style="width:80px">ID</th>
        <th>Título</th>
        <th>Categoría</th>
        <th>Estado</th>
        <th>Universidad</th>
        <th style="width:100px; text-align:center">Acciones</th>
      </tr>

    </ng-template>
    <ng-template pTemplate="body" let-row>
      <tr>
        <td class="text-right">{{ row.id }}</td>
        <td>{{ row.title }}</td>
        <td><p-tag [value]="row.category || '—'" [ngStyle]="tagStyle(row.category || '—',0)"></p-tag></td>
        <td><p-tag [value]="row.status || '—'" [ngStyle]="tagStyle(row.status || '—',1)"></p-tag></td>
        <td>{{ row.university || '—' }}</td>
        <td class="text-center whitespace-nowrap">
          <button pButton type="button" pTooltip="Ver" icon="pi pi-eye" [text]="true" [rounded]="true" [size]="'small'"
                    (click)="openDetail(row)"></button>
          <button pButton type="button" pTooltip="Guardar" icon="pi pi-bookmark" [text]="true" [rounded]="true" [size]="'small'"
                    [disabled]="true"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>