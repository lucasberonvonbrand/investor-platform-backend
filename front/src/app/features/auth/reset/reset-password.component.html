<!-- Modal de error -->
<app-auth-error-modal
  *ngIf="serverError()"
  [open]="!!serverError()"
  [title]="'No pudimos restablecer tu contraseña'"
  [message]="serverError()?.message || ''"
  (close)="serverError.set(null)">
</app-auth-error-modal>

<div class="min-h-screen bg-animated-gradient flex items-center justify-center p-4 relative overflow-hidden">
  <!-- Aquí también podrías añadir las burbujas si este componente no comparte un layout global -->
  <div class="relative w-full max-w-md">
    <div class="bg-white/20 backdrop-blur-lg rounded-2xl shadow-2xl overflow-hidden">
      <div class="p-8 space-y-4">
        <!-- Token detectado o input manual -->
        <div>
          <h2 class="text-lg font-semibold text-slate-800">Restablecer contraseña</h2>

          <label class="block text-sm text-slate-600 mt-3">Token</label>
          <input
              type="text"
              [value]="token()"
              (input)="token.set($any($event.target).value)"
              placeholder="token que recibiste por email"
              class="mt-1 w-full bg-slate-100 text-slate-800 placeholder-slate-400 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:bg-white transition"
              autocomplete="off"
          />
          <p class="text-xs text-slate-500 mt-1">
              Si entraste desde el correo, el token aparece automáticamente.
          </p>
        </div>

        <!-- Form -->
        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-4">

          <div formGroupName="passwordGroup" class="space-y-4">
            <div class="relative">
              <label class="block text-sm text-slate-600">Nueva contraseña</label>
              <input
                [type]="masked() ? 'password' : 'text'"
                class="mt-1 w-full bg-slate-100 text-slate-800 placeholder-slate-400 rounded-lg py-3 px-4 pr-16 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:bg-white transition"
                formControlName="password"
                placeholder="Mínimo 6 caracteres" />
              <button
                type="button"
                (click)="toggleMask(1)"
                class="absolute right-3 top-8 text-xs text-slate-500 hover:text-slate-700 hover:underline">
                {{ masked() ? 'Mostrar' : 'Ocultar' }}
              </button>
              <p *ngIf="invalid(fPassword)" class="mt-1 text-xs text-red-500">
                La contraseña debe tener al menos 6 caracteres.
              </p>
            </div>

            <div class="relative">
              <label class="block text-sm text-slate-600">Confirmar contraseña</label>
              <input
                [type]="masked2() ? 'password' : 'text'"
                class="mt-1 w-full bg-slate-100 text-slate-800 placeholder-slate-400 rounded-lg py-3 px-4 pr-16 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:bg-white transition"
                formControlName="confirm"
                placeholder="Repetí la contraseña" />
              <button
                type="button"
                (click)="toggleMask(2)"
                class="absolute right-3 top-8 text-xs text-slate-500 hover:text-slate-700 hover:underline">
                {{ masked2() ? 'Mostrar' : 'Ocultar' }}
              </button>
              <p *ngIf="invalid(fConfirm)" class="mt-1 text-xs text-red-500">
                Debés repetir la contraseña.
              </p>
              <p *ngIf="fGroup.errors?.['mismatch'] && (fConfirm.touched || fConfirm.dirty)"
                 class="mt-1 text-xs text-red-500">
                Las contraseñas no coinciden.
              </p>
            </div>
          </div>

          <button
            type="submit"
            [disabled]="form.invalid || loading() || !token()"
            class="w-full bg-indigo-600 text-white rounded-lg py-3 px-4 font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all transform hover:scale-105 active:scale-95 disabled:opacity-60">
            <span *ngIf="!loading()">Restablecer contraseña</span>
            <span *ngIf="loading()">Procesando…</span>
          </button>
        </form>

        <!-- Éxito -->
        <div *ngIf="success()" class="rounded-lg border bg-green-50 dark:bg-green-900/20 dark:border-green-900 p-4">
          <p class="text-sm text-green-700 dark:text-green-300">{{ successMsg() }}</p>
          <div class="mt-3">
            <button class="w-full bg-indigo-600 text-white rounded-lg py-3 px-4 font-semibold" (click)="goToLogin()">
              Ir a iniciar sesión
            </button>
          </div>
        </div>

        <div class="text-center text-sm pt-2">
          <a routerLink="/auth/login" class="font-medium text-indigo-600 hover:text-indigo-800 hover:underline transition-colors">Volver a iniciar sesión</a>
        </div>
      </div>
    </div>
  </div>
</div>
