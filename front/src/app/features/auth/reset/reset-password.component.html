<!-- Modal de error -->
<app-auth-error-modal
  *ngIf="serverError()"
  [open]="!!serverError()"
  [title]="'No pudimos restablecer tu contraseña'"
  [message]="serverError()?.message || ''"
  (close)="serverError.set(null)">
</app-auth-error-modal>

<div class="min-h-screen grid place-items-center p-6 bg-gray-50 dark:bg-black">
  <div class="w-full max-w-md space-y-4">

    <!-- Token detectado o input manual -->
        <div class="rounded-xl border bg-white/90 dark:bg-gray-900/80 dark:border-gray-800 p-4 backdrop-blur">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Restablecer contraseña</h2>

        <label class="block text-sm text-gray-600 dark:text-gray-300 mt-3">Token</label>
        <input
            type="text"
            [value]="token()"
            (input)="token.set($any($event.target).value)"
            placeholder="token que recibiste por email"
            class="mt-1 w-full border rounded-lg p-2 dark:bg-gray-800 dark:border-gray-700"
            autocomplete="off"
        />
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
            Si entraste desde el correo, el token aparece automáticamente.
        </p>
        </div>

    <!-- Form -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()"
          class="rounded-xl border bg-white/90 dark:bg-gray-900/80 dark:border-gray-800 p-4 space-y-4 backdrop-blur">

      <div formGroupName="passwordGroup" class="space-y-4">
        <div class="relative">
          <label class="block text-sm text-gray-600 dark:text-gray-300">Nueva contraseña</label>
          <input
            [type]="masked() ? 'password' : 'text'"
            class="mt-1 w-full border rounded-lg p-3 pr-16 dark:bg-gray-800 dark:border-gray-700"
            formControlName="password"
            placeholder="Mínimo 6 caracteres" />
          <button
            type="button"
            (click)="toggleMask(1)"
            class="absolute right-3 top-8 text-xs text-gray-600 dark:text-gray-300 hover:underline">
            {{ masked() ? 'Mostrar' : 'Ocultar' }}
          </button>
          <p *ngIf="invalid(fPassword)" class="mt-1 text-xs text-red-600 dark:text-red-400">
            La contraseña debe tener al menos 6 caracteres.
          </p>
        </div>

        <div class="relative">
          <label class="block text-sm text-gray-600 dark:text-gray-300">Confirmar contraseña</label>
          <input
            [type]="masked2() ? 'password' : 'text'"
            class="mt-1 w-full border rounded-lg p-3 pr-16 dark:bg-gray-800 dark:border-gray-700"
            formControlName="confirm"
            placeholder="Repetí la contraseña" />
          <button
            type="button"
            (click)="toggleMask(2)"
            class="absolute right-3 top-8 text-xs text-gray-600 dark:text-gray-300 hover:underline">
            {{ masked2() ? 'Mostrar' : 'Ocultar' }}
          </button>
          <p *ngIf="invalid(fConfirm)" class="mt-1 text-xs text-red-600 dark:text-red-400">
            Debés repetir la contraseña.
          </p>
          <p *ngIf="fGroup.errors?.['mismatch'] && (fConfirm.touched || fConfirm.dirty)"
             class="mt-1 text-xs text-red-600 dark:text-red-400">
            Las contraseñas no coinciden.
          </p>
        </div>
      </div>

      <button
        type="submit"
        [disabled]="form.invalid || loading() || !token()"
        class="w-full bg-gray-900 text-white rounded-lg p-3 disabled:opacity-60">
        <span *ngIf="!loading()">Restablecer contraseña</span>
        <span *ngIf="loading()">Procesando…</span>
      </button>
    </form>

    <!-- Éxito -->
    <div *ngIf="success()" class="rounded-xl border bg-green-50 dark:bg-green-900/20 dark:border-green-900 p-4">
      <p class="text-sm text-green-700 dark:text-green-300">{{ successMsg() }}</p>
      <div class="mt-3">
        <button class="w-full bg-gray-900 text-white rounded-lg p-3" (click)="goToLogin()">
          Ir a iniciar sesión
        </button>
      </div>
    </div>

    <div class="text-center text-sm">
      <a routerLink="/auth/login" class="underline">Volver a iniciar sesión</a>
    </div>
  </div>
</div>
